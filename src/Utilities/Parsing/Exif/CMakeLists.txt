# ============================================================================
# EXIF Subsystem
# EXIF metadata reading and writing using libexif
# ============================================================================

target_sources(${CMAKE_PROJECT_NAME}
    PRIVATE
        ExifUtility.cc
        ExifUtility.h
)

target_include_directories(${CMAKE_PROJECT_NAME} PRIVATE ${CMAKE_CURRENT_SOURCE_DIR})

# ============================================================================
# libexif Integration
# libexif uses autotools, so we build it directly from source files
# ============================================================================

CPMAddPackage(
    NAME libexif
    VERSION 0.6.25
    GITHUB_REPOSITORY libexif/libexif
    GIT_TAG v0.6.25
    DOWNLOAD_ONLY YES
)

if(libexif_ADDED)
    # Build libexif as a static library from source
    add_library(exif STATIC
        ${libexif_SOURCE_DIR}/libexif/exif-byte-order.c
        ${libexif_SOURCE_DIR}/libexif/exif-content.c
        ${libexif_SOURCE_DIR}/libexif/exif-data.c
        ${libexif_SOURCE_DIR}/libexif/exif-entry.c
        ${libexif_SOURCE_DIR}/libexif/exif-format.c
        ${libexif_SOURCE_DIR}/libexif/exif-gps-ifd.c
        ${libexif_SOURCE_DIR}/libexif/exif-ifd.c
        ${libexif_SOURCE_DIR}/libexif/exif-loader.c
        ${libexif_SOURCE_DIR}/libexif/exif-log.c
        ${libexif_SOURCE_DIR}/libexif/exif-mem.c
        ${libexif_SOURCE_DIR}/libexif/exif-mnote-data.c
        ${libexif_SOURCE_DIR}/libexif/exif-tag.c
        ${libexif_SOURCE_DIR}/libexif/exif-utils.c
        # Canon makernotes
        ${libexif_SOURCE_DIR}/libexif/canon/exif-mnote-data-canon.c
        ${libexif_SOURCE_DIR}/libexif/canon/mnote-canon-entry.c
        ${libexif_SOURCE_DIR}/libexif/canon/mnote-canon-tag.c
        # Fuji makernotes
        ${libexif_SOURCE_DIR}/libexif/fuji/exif-mnote-data-fuji.c
        ${libexif_SOURCE_DIR}/libexif/fuji/mnote-fuji-entry.c
        ${libexif_SOURCE_DIR}/libexif/fuji/mnote-fuji-tag.c
        # Olympus makernotes
        ${libexif_SOURCE_DIR}/libexif/olympus/exif-mnote-data-olympus.c
        ${libexif_SOURCE_DIR}/libexif/olympus/mnote-olympus-entry.c
        ${libexif_SOURCE_DIR}/libexif/olympus/mnote-olympus-tag.c
        # Pentax makernotes
        ${libexif_SOURCE_DIR}/libexif/pentax/exif-mnote-data-pentax.c
        ${libexif_SOURCE_DIR}/libexif/pentax/mnote-pentax-entry.c
        ${libexif_SOURCE_DIR}/libexif/pentax/mnote-pentax-tag.c
    )

    target_include_directories(exif
        PUBLIC
            ${libexif_SOURCE_DIR}
        PRIVATE
            ${libexif_SOURCE_DIR}/libexif
    )

    # Generate config.h (i18n stubs provided by libexif's i18n.h when ENABLE_NLS is undefined)
    set(LIBEXIF_CONFIG_H "${CMAKE_CURRENT_BINARY_DIR}/config.h")
    file(WRITE ${LIBEXIF_CONFIG_H} "
#pragma once
#define PACKAGE \"libexif\"
#define PACKAGE_VERSION \"0.6.25\"
#define VERSION \"0.6.25\"
#define GETTEXT_PACKAGE \"libexif-12\"
")

    # Generate _stdint.h (normally generated by autotools configure)
    set(LIBEXIF_STDINT_DIR "${CMAKE_CURRENT_BINARY_DIR}/libexif")
    file(MAKE_DIRECTORY ${LIBEXIF_STDINT_DIR})
    file(WRITE "${LIBEXIF_STDINT_DIR}/_stdint.h" "
#pragma once
#include <stdint.h>

/* ssize_t is POSIX, not available on Windows/MSVC */
#ifdef _MSC_VER
#include <BaseTsd.h>
typedef SSIZE_T ssize_t;
#else
#include <sys/types.h>
#endif
")
    # Make generated headers available to targets linking against exif
    target_include_directories(exif PUBLIC ${CMAKE_CURRENT_BINARY_DIR})

    # Compiler settings
    target_compile_definitions(exif PRIVATE HAVE_CONFIG_H)
    set_target_properties(exif PROPERTIES
        C_STANDARD 99
        POSITION_INDEPENDENT_CODE ON
    )

    # Suppress warnings in third-party code
    qgc_disable_dependency_warnings(exif)
endif()

target_link_libraries(${CMAKE_PROJECT_NAME} PRIVATE exif)
