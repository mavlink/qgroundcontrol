name: Caching
description: Setup Caching
inputs:
  host:
    description: Host OS
    required: true
  target:
    description: Target OS
    required: true
  build-type:
    description: Build Type
    required: true
  cpm-modules:
    description: Path to CPM Modules
    required: false
  save-cache:
    description: Save cache (set to false for PR builds to save storage)
    required: false
    default: 'true'
runs:
  using: composite
  steps:
    - name: Resolve Python command
      id: python
      shell: bash
      run: |
        if command -v python3 >/dev/null 2>&1; then
          echo "cmd=python3" >> "${GITHUB_OUTPUT}"
        else
          echo "cmd=python" >> "${GITHUB_OUTPUT}"
        fi

    - name: Get ccache config
      id: ccache-config
      shell: bash
      run: |
        # Keep pinned version for reproducibility.
        CCACHE_VERSION="4.10.2"

        # Determine Linux archive architecture for ccache binary.
        if [[ "${{ inputs.target }}" == "linux_gcc_arm64" ]]; then
          arch="aarch64"
        else
          arch="x86_64"
        fi

        "${{ steps.python.outputs.cmd }}" "${{ github.workspace }}/.github/scripts/install_ccache.py" \
          --version "$CCACHE_VERSION" \
          --arch "$arch" \
          --config "${{ github.workspace }}/tools/configs/ccache.conf" \
          --output-only

    - name: Cache ccache binary (Linux)
      if: runner.os == 'Linux'
      id: ccache-binary
      uses: actions/cache@v5
      with:
        path: /usr/local/bin/ccache
        key: ccache-binary-${{ steps.ccache-config.outputs.version }}-linux-${{ steps.ccache-config.outputs.arch }}

    - name: Install ccache (Linux)
      if: runner.os == 'Linux' && steps.ccache-binary.outputs.cache-hit != 'true'
      shell: bash
      run: |
        "${{ steps.python.outputs.cmd }}" "${{ github.workspace }}/.github/scripts/install_ccache.py" \
          --version "${{ steps.ccache-config.outputs.version }}" \
          --arch "${{ steps.ccache-config.outputs.arch }}" \
          --install

    - name: Setup sccache (Windows x64 only)
      if: runner.os == 'Windows' && inputs.target != 'android' && inputs.host != 'windows_arm64'
      uses: mozilla-actions/sccache-action@v0.0.9

    - run: echo "SCCACHE_GHA_ENABLED=${{ inputs.save-cache == 'true' && 'true' || 'false' }}" >> "$GITHUB_ENV"
      if: runner.os == 'Windows' && inputs.target != 'android' && inputs.host != 'windows_arm64'
      shell: bash

    - name: Configure ccache environment (non-Windows)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        echo "CCACHE_DIR=${GITHUB_WORKSPACE}/.ccache" >> "$GITHUB_ENV"
        echo "CCACHE_BASEDIR=${GITHUB_WORKSPACE}" >> "$GITHUB_ENV"
        echo "CCACHE_CONFIGPATH=${GITHUB_WORKSPACE}/tools/configs/ccache.conf" >> "$GITHUB_ENV"
        mkdir -p "${GITHUB_WORKSPACE}/.ccache"

    - name: Setup Build Cache
      if: ${{ !(runner.os == 'Windows' && inputs.target == 'android') }}
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        variant: ${{ runner.os == 'Windows' && inputs.target != 'android' && inputs.host != 'windows_arm64' && 'sccache' || 'ccache' }}
        key: ${{ inputs.host }}-${{ inputs.target }}-${{ inputs.build-type }}
        restore-keys: |
          ${{ inputs.host }}-${{ inputs.target }}
          ${{ inputs.host }}-
        max-size: ${{ steps.ccache-config.outputs.max_size }}
        verbose: 2
        evict-old-files: job
        save: ${{ inputs.save-cache == 'true' }}

    - name: Ensure cpm-modules directory exists
      if: inputs.cpm-modules != ''
      run: mkdir -p "${{ inputs.cpm-modules }}"
      shell: bash

    - name: Cache CPM Modules (restore and save)
      if: inputs.cpm-modules != '' && inputs.save-cache == 'true'
      uses: actions/cache@v5
      with:
        path: ${{ inputs.cpm-modules }}
        key: ${{ github.workflow }}-cpm-modules-${{ hashFiles('**/CMakeLists.txt', '**/*.cmake') }}
        restore-keys: ${{ github.workflow }}-cpm-modules-

    - name: Cache CPM Modules (restore only)
      if: inputs.cpm-modules != '' && inputs.save-cache != 'true'
      uses: actions/cache/restore@v5
      with:
        path: ${{ inputs.cpm-modules }}
        key: ${{ github.workflow }}-cpm-modules-${{ hashFiles('**/CMakeLists.txt', '**/*.cmake') }}
        restore-keys: ${{ github.workflow }}-cpm-modules-
