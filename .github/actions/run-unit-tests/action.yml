name: Run Unit Tests
description: Run unit tests via CTest and generate standardized test artifacts.

inputs:
  build-dir:
    description: Path to CMake build directory
    required: true
  junit-output:
    description: JUnit XML output filename
    required: false
    default: junit-results.xml
  ctest-output:
    description: Captured CTest stdout/stderr filename
    required: false
    default: test-output.txt
  include-labels:
    description: CTest labels regex to include
    required: false
    default: Unit
  exclude-labels:
    description: CTest labels regex to exclude
    required: false
    default: 'Flaky|Network'
  parallel:
    description: Number of parallel CTest jobs, or 'auto'
    required: false
    default: auto

runs:
  using: composite
  steps:
    - name: Detect parallel jobs
      id: jobs
      shell: bash
      env:
        INPUT_PARALLEL: ${{ inputs.parallel }}
      run: |
        if [[ "$INPUT_PARALLEL" != "auto" ]]; then
          JOBS="$INPUT_PARALLEL"
        elif command -v nproc >/dev/null 2>&1; then
          JOBS="$(nproc)"
        elif command -v sysctl >/dev/null 2>&1; then
          JOBS="$(sysctl -n hw.ncpu)"
        elif [[ -n "${NUMBER_OF_PROCESSORS:-}" ]]; then
          JOBS="${NUMBER_OF_PROCESSORS}"
        else
          JOBS=2
        fi

        if [[ ! "$JOBS" =~ ^[0-9]+$ ]] || [[ "$JOBS" -lt 1 ]]; then
          echo "::error::Invalid parallel job count: $JOBS"
          exit 1
        fi

        echo "jobs=$JOBS" >> "$GITHUB_OUTPUT"

    - name: Run CTest
      shell: bash
      working-directory: ${{ inputs.build-dir }}
      env:
        INPUT_JUNIT_OUTPUT: ${{ inputs.junit-output }}
        INPUT_CTEST_OUTPUT: ${{ inputs.ctest-output }}
        INPUT_INCLUDE_LABELS: ${{ inputs.include-labels }}
        INPUT_EXCLUDE_LABELS: ${{ inputs.exclude-labels }}
        INPUT_JOBS: ${{ steps.jobs.outputs.jobs }}
      run: |
        set -o pipefail

        CTEST_ARGS=(
          --output-on-failure
          --output-junit "$INPUT_JUNIT_OUTPUT"
          --parallel "$INPUT_JOBS"
        )

        if [[ -n "$INPUT_INCLUDE_LABELS" ]]; then
          CTEST_ARGS+=(-L "$INPUT_INCLUDE_LABELS")
        fi

        if [[ -n "$INPUT_EXCLUDE_LABELS" ]]; then
          CTEST_ARGS+=(-LE "$INPUT_EXCLUDE_LABELS")
        fi

        ctest "${CTEST_ARGS[@]}" 2>&1 | tee "$INPUT_CTEST_OUTPUT"
