name: Coverage Comment

on:
  workflow_run:
    workflows: [Linux]
    types: [completed]

permissions:
  contents: read
  actions: read
  pull-requests: write

jobs:
  coverage-comment:
    name: Post Coverage Comment
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          sparse-checkout: .github/actions/coverage-comment
          sparse-checkout-cone-mode: false

      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            if (run.pull_requests && run.pull_requests.length > 0) {
              return run.pull_requests[0].number;
            }
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${run.head_branch}`
            });
            return prs.data.length > 0 ? prs.data[0].number : null;

      - name: Download coverage artifact
        if: steps.pr.outputs.result != 'null'
        id: download
        uses: actions/download-artifact@v5
        continue-on-error: true
        with:
          name: coverage-report
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: coverage

      - name: Restore baseline coverage
        if: steps.pr.outputs.result != 'null' && steps.download.outcome == 'success'
        id: baseline
        uses: actions/cache/restore@v4
        with:
          path: baseline-coverage.xml
          key: coverage-baseline-latest

      - name: Post coverage comment
        if: steps.pr.outputs.result != 'null' && steps.download.outcome == 'success'
        uses: ./.github/actions/coverage-comment
        with:
          pr-number: ${{ steps.pr.outputs.result }}
          coverage-xml: coverage/coverage.xml
          baseline-xml: ${{ steps.baseline.outputs.cache-hit == 'true' && 'baseline-coverage.xml' || '' }}

  save-baseline:
    name: Save Coverage Baseline
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.head_branch == 'master' &&
      github.event.workflow_run.conclusion == 'success'
    timeout-minutes: 5

    steps:
      - name: Download coverage artifact
        id: download
        uses: actions/download-artifact@v5
        continue-on-error: true
        with:
          name: coverage-report
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: coverage

      - name: Save baseline coverage
        if: steps.download.outcome == 'success'
        uses: actions/cache/save@v4
        with:
          path: coverage/coverage.xml
          key: coverage-baseline-latest
