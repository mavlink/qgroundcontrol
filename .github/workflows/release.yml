name: Release

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  wait-for-builds:
    name: Wait for Platform Builds
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Wait for builds to complete
        uses: int128/wait-for-workflows-action@v1
        with:
          workflow-names: |
            Linux
            Windows
            MacOS
            Android
          timeout-minutes: 170
          poll-interval-minutes: 5

  upload-artifacts:
    name: Upload Release Artifacts
    needs: wait-for-builds
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      id-token: write
      attestations: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@v6

      - name: Generate SBOM (SPDX)
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: spdx-json
          output-file: sbom.spdx.json
          artifact-name: sbom-spdx

      - name: Generate SBOM (CycloneDX)
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: cyclonedx-json
          output-file: sbom.cdx.json
          artifact-name: sbom-cyclonedx

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: find artifacts -type f | head -50 || echo "No artifacts found"

      - name: Attest Linux AppImage
        uses: actions/attest-sbom@v3
        with:
          subject-path: artifacts/**/QGroundControl*.AppImage
          sbom-path: sbom.spdx.json
        continue-on-error: true

      - name: Attest macOS DMG
        uses: actions/attest-sbom@v3
        with:
          subject-path: artifacts/**/QGroundControl.dmg
          sbom-path: sbom.spdx.json
        continue-on-error: true

      - name: Attest Windows EXE
        uses: actions/attest-sbom@v3
        with:
          subject-path: artifacts/**/QGroundControl*.exe
          sbom-path: sbom.spdx.json
        continue-on-error: true

      - name: Attest Android APK
        uses: actions/attest-sbom@v3
        with:
          subject-path: artifacts/**/QGroundControl.apk
          sbom-path: sbom.spdx.json
        continue-on-error: true

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*.AppImage
            artifacts/**/*.dmg
            artifacts/**/*.exe
            artifacts/**/*.apk
            sbom.spdx.json
            sbom.cdx.json
          fail_on_unmatched_files: false
