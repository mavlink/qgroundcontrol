name: Code Analysis

on:
  workflow_dispatch:
    inputs:
      tool:
        description: 'Analysis tool to run'
        required: true
        default: 'clazy'
        type: choice
        options:
          - clazy
          - iwyu
          - asan
          - ubsan
          - tsan
      path:
        description: 'Path to analyze (clazy/iwyu only, e.g., src/Vehicle/)'
        required: false
        default: ''
        type: string
      analyze_all:
        description: 'Analyze all source files (clazy/iwyu only)'
        required: false
        default: true
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ inputs.tool }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  analyze:
    name: ${{ inputs.tool }} Analysis
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.tool == 'clazy' && 60 || 120 }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Get build config
        id: config
        uses: ./.github/actions/build-config

      - name: Install Dependencies (clazy)
        if: inputs.tool == 'clazy'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: |
            sudo apt-get update
            sudo apt-get install -y clazy ninja-build

      - name: Install Dependencies (iwyu)
        if: inputs.tool == 'iwyu'
        uses: ./.github/actions/install-dependencies
        with:
          extra-packages: iwyu clang ninja-build

      - name: Install Dependencies (sanitizers)
        if: contains(fromJSON('["asan", "ubsan", "tsan"]'), inputs.tool)
        uses: ./.github/actions/install-dependencies

      - name: Install Qt
        uses: ./.github/actions/qt-install
        with:
          version: ${{ steps.config.outputs.qt_version }}
          host: linux
          arch: linux_gcc_64
          modules: ${{ steps.config.outputs.qt_modules }}

      - name: Configure
        working-directory: ${{ runner.temp }}/build
        env:
          CC: ${{ inputs.tool == 'iwyu' && 'clang' || '' }}
          CXX: ${{ inputs.tool == 'iwyu' && 'clang++' || '' }}
        run: |
          CMAKE_ARGS=(
            -S "${{ github.workspace }}"
            -B .
            -G Ninja
            -DCMAKE_BUILD_TYPE=Debug
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          )

          if [[ "${{ contains(fromJSON('["asan", "ubsan", "tsan"]'), inputs.tool) }}" == "true" ]]; then
            CMAKE_ARGS+=(
              -DQGC_BUILD_TESTING=ON
              -DQGC_ENABLE_COVERAGE=OFF
            )

            case "${{ inputs.tool }}" in
              asan)
                CMAKE_ARGS+=(-DQGC_ENABLE_ASAN=ON)
                ;;
              ubsan)
                CMAKE_ARGS+=(-DQGC_ENABLE_UBSAN=ON)
                ;;
              tsan)
                CMAKE_ARGS+=(-DQGC_ENABLE_TSAN=ON)
                ;;
            esac
          fi

          "${QT_ROOT_DIR}/bin/qt-cmake" "${CMAKE_ARGS[@]}"

      - name: Build (sanitizers only)
        if: contains(fromJSON('["asan", "ubsan", "tsan"]'), inputs.tool)
        uses: ./.github/actions/cmake-build
        with:
          build-dir: ${{ runner.temp }}/build
          build-type: Debug

      - name: Run Clazy
        if: inputs.tool == 'clazy'
        working-directory: ${{ github.workspace }}
        env:
          INPUT_PATH: ${{ inputs.path }}
          ANALYZE_ALL: ${{ inputs.analyze_all }}
        run: |
          ARGS=(--tool clazy --build-dir "${RUNNER_TEMP}/build")

          if [[ "$ANALYZE_ALL" == "true" ]]; then
            ARGS+=(--all)
          elif [[ -n "$INPUT_PATH" ]]; then
            if [[ "$INPUT_PATH" =~ \.\. ]] || [[ "$INPUT_PATH" = /* ]]; then
              echo "::error::Invalid path: must be relative, no '..'"
              exit 1
            fi
            ARGS+=("$INPUT_PATH")
          else
            ARGS+=(--all)
          fi

          echo "Running: python3 ./tools/analyze.py ${ARGS[*]}"
          python3 ./tools/analyze.py "${ARGS[@]}"

      - name: Run IWYU
        if: inputs.tool == 'iwyu'
        working-directory: ${{ runner.temp }}/build
        env:
          INPUT_PATH: ${{ inputs.path }}
        run: |
          set +e

          if [[ -n "$INPUT_PATH" ]]; then
            if [[ "$INPUT_PATH" =~ \.\. ]] || [[ "$INPUT_PATH" = /* ]]; then
              echo "::error::Invalid path: must be relative, no '..'"
              exit 1
            fi

            FILES=$(find "${GITHUB_WORKSPACE}/$INPUT_PATH" -type f \( -name "*.cc" -o -name "*.cpp" \) 2>/dev/null | head -100)
            if [[ -z "$FILES" ]]; then
              echo "::error::No source files found in $INPUT_PATH"
              exit 1
            fi

            echo "Analyzing files in: $INPUT_PATH"
            echo "$FILES" | while read -r file; do
              echo "::group::$(basename "$file")"
              iwyu_tool.py -p . "$file" 2>&1 || true
              echo "::endgroup::"
            done | tee iwyu-output.txt
          else
            echo "Analyzing all source files..."
            cmake --build . --target all 2>&1 | tee iwyu-output.txt || true
          fi

          echo ""
          echo "=== IWYU Summary ==="
          grep -E "^(${GITHUB_WORKSPACE}/src/.*should (add|remove)|The full include-list)" iwyu-output.txt | head -200 || echo "No suggestions found"

      - name: Run Sanitizer Tests
        if: contains(fromJSON('["asan", "ubsan", "tsan"]'), inputs.tool)
        uses: ./.github/actions/run-unit-tests
        env:
          ASAN_OPTIONS: ${{ inputs.tool == 'asan' && 'detect_leaks=1:halt_on_error=1:check_initialization_order=1' || '' }}
          LSAN_OPTIONS: ${{ inputs.tool == 'asan' && format('suppressions={0}/build/asan_suppressions.txt', runner.temp) || '' }}
          UBSAN_OPTIONS: ${{ inputs.tool == 'ubsan' && 'print_stacktrace=1:halt_on_error=1' || '' }}
          TSAN_OPTIONS: ${{ inputs.tool == 'tsan' && format('second_deadlock_stack=1:halt_on_error=1:suppressions={0}/build/tsan_suppressions.txt', runner.temp) || '' }}
        with:
          build-dir: ${{ runner.temp }}/build
          junit-output: junit-results-analysis-${{ inputs.tool }}.xml
          ctest-output: sanitizer-output.txt
          include-labels: 'Unit|Integration'
          exclude-labels: 'Flaky|Network'
          parallel: '1'

      - name: Upload Output
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.tool }}-output
          path: |
            ${{ runner.temp }}/build/iwyu-output.txt
            ${{ runner.temp }}/build/sanitizer-output.txt
            ${{ runner.temp }}/build/junit-results-analysis-${{ inputs.tool }}.xml
          if-no-files-found: ignore
          retention-days: 7
