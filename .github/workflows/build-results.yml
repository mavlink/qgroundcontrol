name: Build Results

on:
  workflow_run:
    workflows: [Linux, Windows, MacOS, Android]
    types: [completed]

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write

jobs:
  post-pr-comment:
    name: Post Build Results
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request'
    timeout-minutes: 10

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            .github/scripts/check_sizes.py
            .github/scripts/build_results.py
          sparse-checkout-cone-mode: false

      - name: Get PR number
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            const run = context.payload.workflow_run;
            if (run.pull_requests && run.pull_requests.length > 0) {
              return run.pull_requests[0].number;
            }
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${run.head_branch}`
            });
            return prs.data.length > 0 ? prs.data[0].number : null;

      - name: Collect build status
        if: steps.pr.outputs.result != 'null'
        id: builds
        uses: actions/github-script@v8
        with:
          script: |
            const headSha = context.payload.workflow_run.head_sha;

            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: headSha,
              per_page: 100
            });

            const platforms = {
              'Linux': { status: 'Pending', conclusion: 'pending', url: '' },
              'Windows': { status: 'Pending', conclusion: 'pending', url: '' },
              'MacOS': { status: 'Pending', conclusion: 'pending', url: '' },
              'Android': { status: 'Pending', conclusion: 'pending', url: '' }
            };

            for (const run of runs.data.workflow_runs) {
              if (platforms[run.name]) {
                if (run.status === 'completed') {
                  platforms[run.name].status = run.conclusion === 'success' ? 'Passed' : 'Failed';
                  platforms[run.name].conclusion = run.conclusion;
                  platforms[run.name].url = run.html_url;
                } else if (run.status === 'in_progress') {
                  platforms[run.name].status = 'Running';
                  platforms[run.name].conclusion = 'in_progress';
                  platforms[run.name].url = run.html_url;
                }
              }
            }

            let table = '| Platform | Status | Details |\n|----------|--------|--------|\n';
            for (const [name, info] of Object.entries(platforms)) {
              const link = info.url ? `[View](${info.url})` : '-';
              table += `| ${name} | ${info.status} | ${link} |\n`;
            }

            const allComplete = Object.values(platforms).every(p =>
              ['success', 'failure', 'cancelled'].includes(p.conclusion)
            );
            const allSuccess = Object.values(platforms).every(p => p.conclusion === 'success');

            let summary = '';
            if (allComplete) {
              summary = allSuccess
                ? 'All builds passed.'
                : 'Some builds failed.';
            } else {
              summary = 'Some builds still in progress.';
            }

            core.setOutput('table', table);
            core.setOutput('summary', summary);
            core.setOutput('all_complete', allComplete);

      - name: Download artifacts from triggering workflow
        if: steps.pr.outputs.result != 'null'
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: artifacts

      - name: Restore baseline sizes
        if: steps.pr.outputs.result != 'null'
        id: baseline-sizes
        uses: actions/cache/restore@v5
        continue-on-error: true
        with:
          path: baseline-sizes.json
          key: artifact-sizes-baseline-latest

      - name: Restore baseline coverage
        if: steps.pr.outputs.result != 'null'
        id: baseline-coverage
        uses: actions/cache/restore@v5
        continue-on-error: true
        with:
          path: baseline-coverage.xml
          key: coverage-baseline-latest

      - name: Generate artifact sizes
        if: steps.pr.outputs.result != 'null'
        run: |
          python3 .github/scripts/check_sizes.py artifacts/ --json --output pr-sizes.json 2>/dev/null || true

      - name: Generate combined report
        if: steps.pr.outputs.result != 'null'
        run: |
          args=(
            --artifacts-dir artifacts/
            --output comment.md
          )

          # Add builds table (escape for shell)
          BUILDS_TABLE='${{ steps.builds.outputs.table }}'
          BUILDS_SUMMARY='${{ steps.builds.outputs.summary }}'
          [[ -n "$BUILDS_TABLE" ]] && args+=(--builds-table "$BUILDS_TABLE")
          [[ -n "$BUILDS_SUMMARY" ]] && args+=(--builds-summary "$BUILDS_SUMMARY")

          # Add baselines if available
          [[ -f "pr-sizes.json" ]] && args+=(--pr-sizes pr-sizes.json)
          [[ -f "baseline-sizes.json" ]] && args+=(--baseline-sizes baseline-sizes.json)
          [[ -f "baseline-coverage.xml" ]] && args+=(--baseline-coverage baseline-coverage.xml)

          python3 .github/scripts/build_results.py "${args[@]}"

          # Add footer
          echo "" >> comment.md
          echo "---" >> comment.md
          echo "<sub>Updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC') â€¢ Triggered by: ${{ github.event.workflow_run.name }}</sub>" >> comment.md

          cat comment.md

      - name: Post combined comment
        if: steps.pr.outputs.result != 'null'
        uses: thollander/actions-comment-pull-request@v3
        with:
          pr-number: ${{ steps.pr.outputs.result }}
          comment-tag: build-results
          file-path: comment.md

  save-baselines:
    name: Save Baselines
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.head_branch == 'master' &&
      github.event.workflow_run.conclusion == 'success'
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          sparse-checkout: .github/scripts/check_sizes.py
          sparse-checkout-cone-mode: false

      - name: Download artifacts
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: artifacts

      - name: Save artifact sizes baseline
        run: |
          python3 .github/scripts/check_sizes.py artifacts/ --json --output sizes.json 2>/dev/null || true
          if [[ -f "sizes.json" ]]; then
            echo "Saving artifact sizes baseline"
            cat sizes.json
          fi

      - name: Cache artifact sizes
        if: hashFiles('sizes.json') != ''
        uses: actions/cache/save@v5
        with:
          path: sizes.json
          key: artifact-sizes-baseline-${{ github.run_id }}

      - name: Cache artifact sizes as latest
        if: hashFiles('sizes.json') != ''
        uses: actions/cache/save@v5
        with:
          path: sizes.json
          key: artifact-sizes-baseline-latest

      - name: Save coverage baseline
        if: hashFiles('artifacts/coverage-report/coverage.xml') != ''
        uses: actions/cache/save@v5
        with:
          path: artifacts/coverage-report/coverage.xml
          key: coverage-baseline-latest
