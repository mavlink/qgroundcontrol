name: Cache Cleanup

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to clean (leave empty for all branches)'
        required: false
        type: string
      dry-run:
        description: 'List caches without deleting'
        required: false
        type: boolean
        default: true

permissions:
  actions: write

jobs:
  cleanup:
    name: Cleanup Caches
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Install gh-actions-cache
        run: gh extension install actions/gh-actions-cache
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List caches
        id: list
        env:
          INPUT_BRANCH: ${{ inputs.branch }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          summary_file="$GITHUB_STEP_SUMMARY"
          if [[ -n "$INPUT_BRANCH" ]]; then
            CACHES=$(gh actions-cache list -R "${{ github.repository }}" -B "$INPUT_BRANCH" --order desc --limit 100)
          else
            CACHES=$(gh actions-cache list -R "${{ github.repository }}" --order desc --limit 100)
          fi

          if [[ -z "$CACHES" ]]; then
            {
              echo "## Cache Summary"
              if [[ -n "$INPUT_BRANCH" ]]; then
                echo "Branch filter: \`$INPUT_BRANCH\`"
              fi
              echo "No caches found"
            } >> "$summary_file"
            echo "count=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          COUNT=$(echo "$CACHES" | wc -l)
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

          {
            echo "## Cache Summary"
            if [[ -n "$INPUT_BRANCH" ]]; then
              echo "Branch filter: \`$INPUT_BRANCH\`"
            fi
            echo ""
            echo "| Key | Size | Branch |"
            echo "|-----|------|--------|"
            while read -r KEY SIZE BRANCH; do
              echo "| \`${KEY:0:50}\` | $SIZE | $BRANCH |"
            done <<< "$CACHES"
            echo ""
            echo "**Total: $COUNT caches**"
          } >> "$summary_file"

      - name: Delete caches
        if: ${{ inputs['dry-run'] == false && steps.list.outputs.count != '0' }}
        env:
          INPUT_BRANCH: ${{ inputs.branch }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          summary_file="$GITHUB_STEP_SUMMARY"
          {
            echo ""
            echo "## Deletion Results"
          } >> "$summary_file"

          if [[ -n "$INPUT_BRANCH" ]]; then
            KEYS=$(gh actions-cache list -R "${{ github.repository }}" -B "$INPUT_BRANCH" --limit 100 | cut -f1)
          else
            KEYS=$(gh actions-cache list -R "${{ github.repository }}" --limit 100 | cut -f1)
          fi

          DELETED=0
          FAILED=0

          for KEY in $KEYS; do
            if [[ -n "$INPUT_BRANCH" ]]; then
              DELETE_CMD=(gh actions-cache delete "$KEY" -R "${{ github.repository }}" -B "$INPUT_BRANCH" --confirm)
            else
              DELETE_CMD=(gh actions-cache delete "$KEY" -R "${{ github.repository }}" --confirm)
            fi

            if "${DELETE_CMD[@]}" 2>/dev/null; then
              ((DELETED++))
            else
              ((FAILED++))
            fi
          done

          {
            echo "Deleted: $DELETED"
            if [[ $FAILED -gt 0 ]]; then
              echo "Failed: $FAILED"
            fi
          } >> "$summary_file"

      - name: Dry run notice
        if: ${{ inputs['dry-run'] == true }}
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "> **Dry run** - no caches were deleted. Uncheck 'dry-run' to delete." >> "$GITHUB_STEP_SUMMARY"
