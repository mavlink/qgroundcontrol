name: Build Summary

on:
  workflow_run:
    workflows: [Linux, Windows, MacOS, Android]
    types: [completed]

permissions:
  pull-requests: write
  actions: read

jobs:
  summary:
    name: Post Build Summary
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request'
    timeout-minutes: 10

    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            // Try to get PR number from the workflow run
            const run = context.payload.workflow_run;
            if (run.pull_requests && run.pull_requests.length > 0) {
              return run.pull_requests[0].number;
            }

            // Fallback: search for PR by head SHA
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${run.head_branch}`
            });

            if (prs.data.length > 0) {
              return prs.data[0].number;
            }

            return null;

      - name: Collect build results
        if: steps.pr.outputs.result != 'null'
        id: results
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.result }};
            const headSha = context.payload.workflow_run.head_sha;

            // Get all workflow runs for this commit
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: headSha,
              per_page: 100
            });

            const platforms = {
              'Linux': { status: '‚è≥', conclusion: 'pending' },
              'Windows': { status: '‚è≥', conclusion: 'pending' },
              'MacOS': { status: '‚è≥', conclusion: 'pending' },
              'Android': { status: '‚è≥', conclusion: 'pending' }
            };

            for (const run of runs.data.workflow_runs) {
              if (platforms[run.name]) {
                if (run.status === 'completed') {
                  platforms[run.name].status = run.conclusion === 'success' ? '‚úÖ' : '‚ùå';
                  platforms[run.name].conclusion = run.conclusion;
                  platforms[run.name].url = run.html_url;
                } else if (run.status === 'in_progress') {
                  platforms[run.name].status = 'üîÑ';
                  platforms[run.name].conclusion = 'in_progress';
                  platforms[run.name].url = run.html_url;
                }
              }
            }

            return platforms;

      - name: Post or update comment
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.result }};
            const platforms = ${{ steps.results.outputs.result }};
            const marker = '<!-- build-summary-bot -->';

            // Build the comment body
            let body = `${marker}\n## üèóÔ∏è Build Status\n\n`;
            body += `| Platform | Status | Details |\n`;
            body += `|----------|--------|--------|\n`;

            for (const [name, info] of Object.entries(platforms)) {
              const link = info.url ? `[View](${info.url})` : '-';
              body += `| ${name} | ${info.status} | ${link} |\n`;
            }

            const allComplete = Object.values(platforms).every(p =>
              p.conclusion === 'success' || p.conclusion === 'failure' || p.conclusion === 'cancelled'
            );
            const allSuccess = Object.values(platforms).every(p => p.conclusion === 'success');

            if (allComplete) {
              if (allSuccess) {
                body += `\n‚úÖ **All builds passed!**`;
              } else {
                body += `\n‚ùå **Some builds failed.** Please check the logs.`;
              }
            } else {
              body += `\n‚è≥ *Some builds are still in progress...*`;
            }

            body += `\n\n<sub>Last updated: ${new Date().toISOString()}</sub>`;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const existingComment = comments.data.find(c => c.body.includes(marker));

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
              console.log(`Updated comment ${existingComment.id}`);
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
              console.log(`Created new comment on PR #${prNumber}`);
            }
