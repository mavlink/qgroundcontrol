name: Build Windows Release + NSIS Installer

on:
  workflow_dispatch:
  push:
    tags: ["v*"]

jobs:
  build-and-package:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Python 3.10 (global)
        id: setup_python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Set Python 3.10 as default for all steps
        run: |
          echo "Prepending Python 3.10 to PATH and setting PYTHONHOME for all steps."
          echo "PYTHONHOME=${{ steps.setup_python.outputs.python-path }}" >> $GITHUB_ENV
          echo "${{ steps.setup_python.outputs.python-path }}" | sed 's|/python.exe||' >> $GITHUB_PATH

      - name: Check Python version (strict)
        run: |
          python --version
          where python
          python -c "import sys; assert sys.version_info[:2] == (3, 10), 'Python 3.10 is required'"

      - name: Install aqtinstall
        run: |
          python -m pip install --upgrade pip
          python -m pip install aqtinstall

      - name: Install Qt with aqtinstall
        run: |
          python -m aqt install-qt windows desktop 6.10.2 win64_msvc2022_64 --outputdir ${{ runner.temp }}/qt
          python -m aqt install-tool windows desktop tools_cmake --outputdir ${{ runner.temp }}/qt
          python -m aqt install-tool windows desktop tools_ifw --outputdir ${{ runner.temp }}/qt
          python -m aqt install-qt windows desktop 6.10.2 win64_msvc2022_64 --modules qtcharts qtlocation qt5compat qtmultimedia qtserialport qtpositioning qtimageformats qtquick3d qtquicktimeline qtshadertools qtsensors qtconnectivity qtspeech qtscxml --outputdir ${{ runner.temp }}/qt

      - name: Add Qt bin to PATH
        run: echo "${{ runner.temp }}/qt/6.10.2/msvc2022_64/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Print Python info for CMake
        run: |
          echo "Python executable: $(python -c 'import sys; print(sys.executable)')"
          python --version
          where python
      - name: Set Python 3.10 as default for build
        id: setpy
        run: |
          echo "##[group]Python 3.10 paths"
          $PYTHON_DIR = (python -c "import sys; import os; print(os.path.dirname(sys.executable))")
          echo "PYTHON_DIR=$PYTHON_DIR" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "PYTHONHOME=$PYTHON_DIR" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "$PYTHON_DIR" | Out-File -FilePath $env:GITHUB_PATH -Append
          echo "##[endgroup]"

      - name: Configure CMake (MSVC)
        run: |
          $PYTHON_EXE = $(python -c "import sys; print(sys.executable)")
          $PYTHON_ROOT = Split-Path (Split-Path $PYTHON_EXE -Parent) -Parent
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="${{ runner.temp }}/qt/6.10.2/msvc2022_64" -DPython3_ROOT_DIR="$PYTHON_ROOT" -DPYTHON_EXECUTABLE="$PYTHON_EXE"

      - name: Build (Release)
        run: |
          cmake --build build --config Release -- /m

      - name: Bundle Qt runtime with windeployqt
        run: |
          $exe = 'build\Release\garudxgcs.exe'
          if (-not (Test-Path $exe)) { $exe = 'build\garudxgcs\Release\garudxgcs.exe' }
          Write-Host "Using exe: $exe"
          & "${{ runner.temp }}/qt/6.10.2/msvc2022_64/bin/windeployqt.exe" --qmldir src --release $exe

      - name: Include JetBrains Mono font in installer output
        run: |
          Write-Host "Downloading JetBrains Mono latest release and bundling TTFs into installer_out"
          $release = Invoke-RestMethod -Uri 'https://api.github.com/repos/JetBrains/JetBrainsMono/releases/latest'
          $asset = $release.assets | Where-Object { $_.name -match 'JetBrainsMono.*zip' } | Select-Object -First 1
          $outdir = "$PWD\\installer_out"
          if ($null -ne $asset) {
            $url = $asset.browser_download_url
            Invoke-WebRequest -Uri $url -OutFile jetbrainsmono.zip
            Expand-Archive -Path jetbrainsmono.zip -DestinationPath fonts -Force
            $ttfs = Get-ChildItem -Path fonts -Recurse -Include *.ttf
            $dest = Join-Path $outdir 'fonts'
            New-Item -ItemType Directory -Path $dest -Force | Out-Null
            foreach ($f in $ttfs) { Copy-Item $f.FullName -Destination $dest -Force }
            # create launcher
            $launcher = Join-Path $outdir 'garudxgcs.bat'
            $exeName = 'garudxgcs.exe'
            $bat = "@echo off`r`nset QT_FONTDIR=%~dp0fonts`r`nstart \"\" \"%~dp0$exeName%\""
            Set-Content -Path $launcher -Value $bat -Encoding ASCII
          } else {
            Write-Host "JetBrains Mono asset not found; skipping bundling"
          }

      - name: Install NSIS
        run: |
          choco install nsis -y

      - name: Create installer using NSIS
        run: |
          $outdir = "$PWD\\installer_out"
          Remove-Item -Recurse -Force $outdir -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path $outdir
          Copy-Item -Path build\\Release\\* -Destination $outdir -Recurse -Force
          # Run makensis on our NSI script
          & "C:\\Program Files (x86)\\NSIS\\makensis.exe" -V2 tools\\packaging\\garudxgcs_installer.nsi /DOUTDIR=$outdir

      - name: Package installer zip
        run: |
          Compress-Archive -Path installer_out\* -DestinationPath garudxgcs-windows-installer.zip -Force

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: garudxgcs-windows-installer
          path: garudxgcs-windows-installer.zip

      - name: Create GitHub Release (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release asset (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: garudxgcs-windows-installer.zip
