name: Size Check

on:
  workflow_run:
    workflows: [Linux, Windows, MacOS, Android]
    types: [completed]

permissions:
  contents: read
  actions: read
  pull-requests: write

jobs:
  check-size:
    name: Check Artifact Sizes
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          sparse-checkout: tools/check-sizes.py
          sparse-checkout-cone-mode: false

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: artifacts

      - name: Check sizes
        id: sizes
        run: |
          python tools/check-sizes.py artifacts/ \
            --json \
            --output sizes.json \
            --summary "$GITHUB_STEP_SUMMARY" \
            --no-fail
          python tools/check-sizes.py artifacts/ --markdown > sizes.md

      - name: Upload size report
        uses: actions/upload-artifact@v6
        with:
          name: size-report-${{ github.event.workflow_run.id }}
          path: sizes.json
          retention-days: 90

      - name: Save baseline sizes (master only)
        if: github.event.workflow_run.head_branch == 'master'
        uses: actions/cache/save@v5
        with:
          path: sizes.json
          key: artifact-sizes-baseline-${{ github.run_id }}

      - name: Save baseline sizes as latest
        if: github.event.workflow_run.head_branch == 'master'
        uses: actions/cache/save@v5
        with:
          path: sizes.json
          key: artifact-sizes-baseline-latest

      - name: Check for warnings
        run: |
          if python -c "import json; d=json.load(open('sizes.json')); exit(0 if d['warning_count'] > 0 else 1)" 2>/dev/null; then
            echo "::warning::Artifact size thresholds exceeded. See size report for details."
          fi

  comment-pr:
    name: Post Size Comment
    runs-on: ubuntu-latest
    needs: check-size
    if: github.event.workflow_run.event == 'pull_request'
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          sparse-checkout: tools/check-sizes.py
          sparse-checkout-cone-mode: false

      - name: Get PR number
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            const run = context.payload.workflow_run;
            if (run.pull_requests && run.pull_requests.length > 0) {
              return run.pull_requests[0].number;
            }
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${run.head_branch}`
            });
            return prs.data.length > 0 ? prs.data[0].number : null;

      - name: Download PR artifacts
        if: steps.pr.outputs.result != 'null'
        uses: actions/download-artifact@v7
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: artifacts-pr

      - name: Restore baseline sizes
        if: steps.pr.outputs.result != 'null'
        id: baseline
        uses: actions/cache/restore@v5
        with:
          path: baseline-sizes.json
          key: artifact-sizes-baseline-latest

      - name: Compare sizes
        if: steps.pr.outputs.result != 'null'
        id: compare
        run: |
          python tools/check-sizes.py artifacts-pr/ --json --output pr-sizes.json --no-fail
          python3 << 'EOF'
          import json
          import os

          with open('pr-sizes.json') as f:
              pr_data = json.load(f)

          baseline = {}
          if os.path.exists('baseline-sizes.json'):
              with open('baseline-sizes.json') as f:
                  baseline_data = json.load(f)
                  baseline = {a['name']: a for a in baseline_data.get('artifacts', [])}

          lines = ['## ðŸ“¦ Artifact Size Report', '']

          if baseline:
              lines.extend([
                  '| Artifact | Size | Î” from master | Status |',
                  '|----------|------|---------------|--------|'
              ])
          else:
              lines.extend([
                  '| Artifact | Size | Threshold | Status |',
                  '|----------|------|-----------|--------|'
              ])

          total_delta = 0
          for a in pr_data['artifacts']:
              name = a['name']
              size = a['size_human']
              status = 'âš ï¸' if a['exceeds_threshold'] else 'âœ…'

              if baseline and name in baseline:
                  old_size = baseline[name]['size_bytes']
                  new_size = a['size_bytes']
                  delta = new_size - old_size
                  total_delta += delta

                  if delta > 0:
                      delta_str = f'+{delta / 1024 / 1024:.2f} MB ðŸ“ˆ'
                  elif delta < 0:
                      delta_str = f'{delta / 1024 / 1024:.2f} MB ðŸ“‰'
                  else:
                      delta_str = 'No change'

                  lines.append(f'| {name} | {size} | {delta_str} | {status} |')
              else:
                  threshold = f"{a['threshold_mb']} MB" if a['threshold_mb'] else '-'
                  lines.append(f'| {name} | {size} | {threshold} | {status} |')

          lines.append('')
          if baseline and total_delta != 0:
              direction = 'increased' if total_delta > 0 else 'decreased'
              lines.append(f'**Total size {direction} by {abs(total_delta) / 1024 / 1024:.2f} MB**')
          elif not baseline:
              lines.append('*No baseline available for comparison (first build or cache expired)*')

          with open('size-comment.md', 'w') as f:
              f.write('\n'.join(lines))
          EOF
          cat size-comment.md

      - name: Post PR comment
        if: steps.pr.outputs.result != 'null'
        uses: thollander/actions-comment-pull-request@v3
        with:
          pr-number: ${{ steps.pr.outputs.result }}
          comment-tag: artifact-sizes
          file-path: size-comment.md
