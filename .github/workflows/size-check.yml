name: Size Check

on:
  workflow_run:
    workflows: [Linux, Windows, MacOS, Android]
    types: [completed]
    branches: [master]

permissions:
  contents: read
  actions: read

jobs:
  check-size:
    name: Check Artifact Sizes
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    timeout-minutes: 15

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v5
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: artifacts

      - name: Check sizes
        id: sizes
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Size thresholds in bytes
            const thresholds = {
              'AppImage': 200 * 1024 * 1024,  // 200 MB
              'dmg': 150 * 1024 * 1024,       // 150 MB
              'exe': 200 * 1024 * 1024,       // 200 MB
              'apk': 150 * 1024 * 1024        // 150 MB
            };

            // Warning threshold (% increase from baseline)
            const warningPercent = 10;

            function getFiles(dir, files = []) {
              if (!fs.existsSync(dir)) return files;
              const items = fs.readdirSync(dir);
              for (const item of items) {
                const fullPath = path.join(dir, item);
                if (fs.statSync(fullPath).isDirectory()) {
                  getFiles(fullPath, files);
                } else {
                  files.push(fullPath);
                }
              }
              return files;
            }

            const files = getFiles('artifacts');
            const sizes = {};
            const warnings = [];

            for (const file of files) {
              const stats = fs.statSync(file);
              const ext = path.extname(file).slice(1);
              const name = path.basename(file);
              const sizeMB = (stats.size / (1024 * 1024)).toFixed(2);

              sizes[name] = {
                bytes: stats.size,
                mb: sizeMB,
                extension: ext
              };

              console.log(`${name}: ${sizeMB} MB`);

              // Check against threshold
              const threshold = thresholds[ext];
              if (threshold && stats.size > threshold) {
                const thresholdMB = (threshold / (1024 * 1024)).toFixed(0);
                warnings.push(`âš ï¸ ${name} (${sizeMB} MB) exceeds ${thresholdMB} MB threshold`);
              }
            }

            // Output sizes as JSON
            fs.writeFileSync('sizes.json', JSON.stringify(sizes, null, 2));

            // Create summary
            let summary = '## ðŸ“¦ Artifact Sizes\n\n';
            summary += '| Artifact | Size |\n';
            summary += '|----------|------|\n';

            for (const [name, info] of Object.entries(sizes)) {
              summary += `| ${name} | ${info.mb} MB |\n`;
            }

            if (warnings.length > 0) {
              summary += '\n### âš ï¸ Warnings\n';
              summary += warnings.join('\n');
            }

            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary);

            return { sizes, warnings };

      - name: Upload size report
        uses: actions/upload-artifact@v5
        with:
          name: size-report-${{ github.event.workflow_run.id }}
          path: sizes.json
          retention-days: 90

      - name: Warn on size regression
        if: steps.sizes.outputs.result != ''
        uses: actions/github-script@v7
        with:
          script: |
            const result = ${{ steps.sizes.outputs.result }};
            if (result.warnings && result.warnings.length > 0) {
              core.warning(`Artifact size warnings:\n${result.warnings.join('\n')}`);
            }
