name: Test Report

on:
  workflow_run:
    workflows: [Linux]
    types: [completed]

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write

jobs:
  report:
    name: Post Test Report
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request'
    timeout-minutes: 10

    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            const run = context.payload.workflow_run;
            if (run.pull_requests && run.pull_requests.length > 0) {
              return run.pull_requests[0].number;
            }
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${run.head_branch}`
            });
            return prs.data.length > 0 ? prs.data[0].number : null;

      - name: Download test artifacts
        if: steps.pr.outputs.result != 'null'
        id: download
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          pattern: test-results-*
          path: test-results
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse test results
        if: steps.pr.outputs.result != 'null' && steps.download.outcome == 'success'
        id: parse
        run: |
          echo "## Test Results" > comment.md
          echo "" >> comment.md

          TOTAL_PASSED=0
          TOTAL_FAILED=0
          TOTAL_SKIPPED=0

          for dir in test-results/*/; do
            if [[ -f "${dir}test-output.txt" ]]; then
              ARCH=$(basename "$dir" | sed 's/test-results-//')
              echo "### $ARCH" >> comment.md
              echo "" >> comment.md

              # Parse Qt Test output
              PASSED=$(grep -c "^PASS" "${dir}test-output.txt" 2>/dev/null || echo "0")
              FAILED=$(grep -c "^FAIL" "${dir}test-output.txt" 2>/dev/null || echo "0")
              SKIPPED=$(grep -c "^SKIP" "${dir}test-output.txt" 2>/dev/null || echo "0")

              TOTAL_PASSED=$((TOTAL_PASSED + PASSED))
              TOTAL_FAILED=$((TOTAL_FAILED + FAILED))
              TOTAL_SKIPPED=$((TOTAL_SKIPPED + SKIPPED))

              if [[ "$FAILED" -gt 0 ]]; then
                echo "❌ **$PASSED passed, $FAILED failed, $SKIPPED skipped**" >> comment.md
                echo "" >> comment.md
                echo "<details><summary>Failed tests</summary>" >> comment.md
                echo "" >> comment.md
                echo '```' >> comment.md
                grep "^FAIL" "${dir}test-output.txt" | head -20 >> comment.md
                echo '```' >> comment.md
                echo "</details>" >> comment.md
              else
                echo "✅ **$PASSED passed, $SKIPPED skipped**" >> comment.md
              fi
              echo "" >> comment.md
            fi
          done

          echo "---" >> comment.md
          if [[ "$TOTAL_FAILED" -gt 0 ]]; then
            echo "**Total: $TOTAL_PASSED passed, $TOTAL_FAILED failed, $TOTAL_SKIPPED skipped**" >> comment.md
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "**Total: $TOTAL_PASSED passed, $TOTAL_SKIPPED skipped** ✅" >> comment.md
            echo "status=success" >> $GITHUB_OUTPUT
          fi

          cat comment.md

      - name: Post test results comment
        if: steps.pr.outputs.result != 'null' && steps.download.outcome == 'success'
        uses: thollander/actions-comment-pull-request@v3
        with:
          pr-number: ${{ steps.pr.outputs.result }}
          comment-tag: test-results
          file-path: comment.md
