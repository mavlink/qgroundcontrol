name: Linux

on:
  push:
    branches:
      - master
      - 'Stable*'
    tags:
      - 'v*'
    paths-ignore:
      - 'docs/**'
  pull_request:
    paths:
      - '.github/workflows/linux.yml'
      - '.github/actions/**'
      - 'deploy/linux/**'
      - 'src/**'
      - 'test/**'
      - 'CMakeLists.txt'
      - 'cmake/**'
      - 'tools/setup/*debian*'
      - 'tools/setup/install_dependencies.py'
  merge_group:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: false
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/master' }}

permissions:
  contents: read
  id-token: write
  attestations: write
  security-events: write
  actions: read

jobs:
  build:
    name: Build ${{ matrix.arch }} ${{ matrix.build_type }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 120

    strategy:
      fail-fast: false
      matrix:
        build_type: ${{ inputs.build_type && fromJSON(format('["{0}"]', inputs.build_type)) || fromJSON('["Debug", "Release"]') }}
        os: [ubuntu-24.04-arm, ubuntu-22.04]
        include:
          - os: ubuntu-24.04-arm
            package: QGroundControl-aarch64
            host: linux_arm64
            arch: linux_gcc_arm64

          - os: ubuntu-22.04
            package: QGroundControl-x86_64
            host: linux
            arch: linux_gcc_64

        exclude:
          - os: ubuntu-24.04-arm
            build_type: Debug

    defaults:
      run:
        shell: bash

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Build Setup
        uses: ./.github/actions/build-setup
        with:
          qt-host: ${{ matrix.host }}
          qt-arch: ${{ matrix.arch }}
          build-type: ${{ matrix.build_type }}
          save-cache: ${{ github.event_name != 'pull_request' }}

      - name: Install Dependencies
        uses: ./.github/actions/install-dependencies

      - name: Initialize CodeQL
        if: matrix.build_type == 'Debug' && github.event_name != 'pull_request'
        uses: github/codeql-action/init@v4
        with:
          languages: c-cpp
          config-file: ./.github/codeql/codeql-config.yml

      - name: Configure
        uses: ./.github/actions/cmake-configure
        with:
          build-dir: ${{ runner.temp }}/build
          build-type: ${{ matrix.build_type }}
          testing: ${{ matrix.build_type == 'Debug' && 'true' || 'false' }}
          coverage: ${{ matrix.build_type == 'Debug' && 'true' || 'false' }}
          stable: ${{ (github.ref_type == 'tag' || contains(github.ref, 'Stable')) && 'true' || 'false' }}

      - name: Build
        uses: ./.github/actions/cmake-build
        with:
          build-dir: ${{ runner.temp }}/build
          build-type: ${{ matrix.build_type }}

      - name: Perform CodeQL Analysis
        if: matrix.build_type == 'Debug' && github.event_name != 'pull_request'
        continue-on-error: true
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:c-cpp"

      - name: Upload Debug Build Artifacts
        if: matrix.build_type == 'Debug'
        uses: actions/upload-artifact@v6
        with:
          name: debug-build-${{ matrix.arch }}
          path: ${{ runner.temp }}/build
          retention-days: 1

      - name: Verify Executable
        if: matrix.build_type == 'Release'
        uses: ./.github/actions/verify-executable
        with:
          binary-path: ${{ runner.temp }}/build/${{ matrix.build_type }}/QGroundControl

      - name: Create AppImage
        working-directory: ${{ runner.temp }}/build
        run: cmake --install . --config ${{ matrix.build_type }}

      - name: Verify AppImage
        if: matrix.build_type == 'Release'
        uses: ./.github/actions/verify-executable
        with:
          binary-path: ${{ runner.temp }}/build/${{ matrix.package }}.AppImage
          type: appimage

      - name: Attest Build with SBOM
        if: matrix.build_type == 'Release'
        uses: ./.github/actions/attest-sbom
        with:
          subject-path: ${{ runner.temp }}/build/${{ matrix.package }}.AppImage
          subject-name: ${{ matrix.package }}
          scan-path: ${{ runner.temp }}/build

      - name: Upload Build File
        if: matrix.build_type == 'Release'
        uses: ./.github/actions/upload
        with:
          artifact_name: ${{ matrix.package }}.AppImage
          package_name: ${{ matrix.package }}
          aws_role_arn: ${{ secrets.AWS_ROLE_ARN }}
          aws_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws_distribution_id: ${{ secrets.AWS_DISTRIBUTION_ID }}

  test:
    name: Test + Coverage linux_gcc_64 Debug
    needs: build
    if: ${{ !cancelled() && needs.build.result == 'success' && (github.event_name != 'workflow_dispatch' || inputs.build_type == 'Debug') }}
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    defaults:
      run:
        shell: bash

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Restore file timestamps
        uses: chetan/git-restore-mtime-action@v2

      - name: Get build config
        id: config
        uses: ./.github/actions/build-config

      - uses: lukka/get-cmake@v4.2.3

      - name: Install Dependencies
        uses: ./.github/actions/install-dependencies

      - name: Install Qt for Linux
        uses: ./.github/actions/qt-install
        with:
          host: linux
          arch: linux_gcc_64
          version: ${{ steps.config.outputs.qt_version }}
          modules: ${{ steps.config.outputs.qt_modules }}

      - name: Download Debug Build
        uses: actions/download-artifact@v7
        with:
          name: debug-build-linux_gcc_64
          path: ${{ runner.temp }}/build

      - name: Restore executable permissions
        run: |
          find "${{ runner.temp }}/build" -name '*.so*' -exec chmod +x {} +
          find "${{ runner.temp }}/build" -path '*/bin/*' -exec chmod +x {} +
          find "${{ runner.temp }}/build" -path '*/Debug/*' -type f ! -name '*.o' ! -name '*.a' -exec chmod +x {} +
          chmod -f +x "${{ runner.temp }}/build/Debug/QGroundControl" || true
          find "${{ runner.temp }}/build" -name 'tst_*' -exec chmod +x {} +

      - name: Run Unit Tests
        uses: ./.github/actions/run-unit-tests
        with:
          build-dir: ${{ runner.temp }}/build
          junit-output: junit-results-linux-linux_gcc_64.xml
          ctest-output: test-output-linux-linux_gcc_64.txt
          include-labels: 'Unit|Integration'
          exclude-labels: 'Flaky|Network'
          parallel: auto

      - name: Analyze Unit Test Durations
        if: always()
        uses: ./.github/actions/test-duration-report
        with:
          junit-path: ${{ runner.temp }}/build/junit-results-linux-linux_gcc_64.xml
          baseline-path: ${{ github.workspace }}/.github/test-duration-baseline.json
          report-json-path: ${{ runner.temp }}/build/test-duration-linux-linux_gcc_64.json
          top-n: '20'
          slow-threshold-seconds: '60'
          regression-factor: '1.5'
          min-delta-seconds: '5'
          fail-on-regression: 'false'

      - name: Report Test Results
        if: always()
        uses: ./.github/actions/test-report
        with:
          name: Unit Tests (linux_gcc_64)
          build-dir: ${{ runner.temp }}/build
          junit-file: junit-results-linux-linux_gcc_64.xml
          output-file: test-output-linux-linux_gcc_64.txt
          artifact-name: test-results-linux_gcc_64
          retention-days: 7
          trunk-org-slug: ${{ vars.TRUNK_ORG_SLUG }}
          trunk-token: ${{ secrets.TRUNK_TOKEN }}

      - name: Upload Duration Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-duration-linux_gcc_64
          path: ${{ runner.temp }}/build/test-duration-linux-linux_gcc_64.json
          retention-days: 7

      - name: Install coverage tools
        run: |
          sudo apt-get install -y --no-install-recommends ccache
          # Ensure ccache is at /usr/local/bin where the build's ccache-launcher expects it
          if [ ! -f /usr/local/bin/ccache ] && command -v ccache >/dev/null 2>&1; then
            sudo ln -s "$(command -v ccache)" /usr/local/bin/ccache
          fi
          pipx install gcovr

      - name: Coverage Report
        uses: ./.github/actions/coverage
        with:
          build-dir: ${{ runner.temp }}/build
          mode: report-only

      - name: Verify Coverage Thresholds
        working-directory: ${{ runner.temp }}/build
        run: |
          python3 - <<'PY'
          import sys
          import xml.etree.ElementTree as ET
          from pathlib import Path

          if not Path("coverage.xml").exists():
              print("::warning::coverage.xml not found, skipping threshold check")
              sys.exit(0)

          tree = ET.parse("coverage.xml")
          cov = tree.getroot()
          line_rate = float(cov.get("line-rate", 0)) * 100
          branch_rate = float(cov.get("branch-rate", 0)) * 100

          print(f"Line coverage: {line_rate:.1f}% (threshold: 30%)")
          print(f"Branch coverage: {branch_rate:.1f}% (threshold: 20%)")

          failed = False
          if line_rate < 30:
              print(f"::error::Line coverage {line_rate:.1f}% is below 30% threshold")
              failed = True
          if branch_rate < 20:
              print(f"::error::Branch coverage {branch_rate:.1f}% is below 20% threshold")
              failed = True

          sys.exit(1 if failed else 0)
          PY

  sanitizers:
    name: Sanitizers linux_gcc_64 Debug (ASan+UBSan)
    if: github.event_name != 'workflow_dispatch' || inputs.build_type == 'Debug'
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    defaults:
      run:
        shell: bash

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          fetch-tags: true

      - name: Build Setup
        uses: ./.github/actions/build-setup
        with:
          qt-host: linux
          qt-arch: linux_gcc_64
          build-type: Debug
          save-cache: ${{ github.event_name != 'pull_request' }}

      - name: Install Dependencies
        uses: ./.github/actions/install-dependencies

      - name: Configure (ASan+UBSan)
        uses: ./.github/actions/cmake-configure
        with:
          build-dir: ${{ runner.temp }}/build
          build-type: Debug
          testing: 'true'
          stable: ${{ (github.ref_type == 'tag' || contains(github.ref, 'Stable')) && 'true' || 'false' }}
          extra-args: -DQGC_ENABLE_ASAN=ON -DQGC_ENABLE_UBSAN=ON

      - name: Build (ASan+UBSan)
        uses: ./.github/actions/cmake-build
        with:
          build-dir: ${{ runner.temp }}/build
          build-type: Debug

      - name: Run Unit Tests (ASan+UBSan)
        uses: ./.github/actions/run-unit-tests
        env:
          ASAN_OPTIONS: detect_leaks=1:halt_on_error=1:check_initialization_order=1
          LSAN_OPTIONS: suppressions=${{ runner.temp }}/build/asan_suppressions.txt
          UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1
        with:
          build-dir: ${{ runner.temp }}/build
          junit-output: junit-results-linux-sanitizers.xml
          ctest-output: test-output-linux-sanitizers.txt
          include-labels: 'Unit|Integration'
          exclude-labels: 'Flaky|Network'
          parallel: '1'

      - name: Analyze Unit Test Durations (Sanitizers)
        if: always()
        uses: ./.github/actions/test-duration-report
        with:
          junit-path: ${{ runner.temp }}/build/junit-results-linux-sanitizers.xml
          baseline-path: ${{ github.workspace }}/.github/test-duration-baseline.json
          report-json-path: ${{ runner.temp }}/build/test-duration-linux-sanitizers.json
          top-n: '20'
          slow-threshold-seconds: '60'
          regression-factor: '1.5'
          min-delta-seconds: '5'
          fail-on-regression: 'false'

      - name: Upload Test Results (Sanitizers)
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results-linux-sanitizers
          path: |
            ${{ runner.temp }}/build/test-output-linux-sanitizers.txt
            ${{ runner.temp }}/build/junit-results-linux-sanitizers.xml
            ${{ runner.temp }}/build/test-duration-linux-sanitizers.json
          retention-days: 7
