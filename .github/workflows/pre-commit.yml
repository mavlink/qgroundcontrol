name: pre-commit

on:
  push:
    branches:
      - master
      - 'Stable*'
    paths:
      - 'src/**'
      - 'test/**'
      - '.pre-commit-config.yaml'
  pull_request:
    paths:
      - 'src/**'
      - 'test/**'
      - '.pre-commit-config.yaml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/master' }}

permissions:
  contents: read

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get build config
        id: config
        uses: ./.github/actions/build-config

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Install Qt (for qmllint)
        uses: ./.github/actions/qt-install
        with:
          version: ${{ steps.config.outputs.qt_version }}
          host: linux
          arch: linux_gcc_64
          modules: ${{ steps.config.outputs.qt_modules }}

      - name: Run pre-commit
        id: pre-commit
        continue-on-error: true
        uses: pre-commit/action@v3.0.1

      - name: Show diff on failure
        if: steps.pre-commit.outcome == 'failure'
        run: |
          echo "::group::Files modified by pre-commit hooks"
          git diff --stat
          echo "::endgroup::"
          echo ""
          echo "::group::Full diff (apply these changes to fix)"
          git diff --color=always
          echo "::endgroup::"
          echo ""
          echo "ðŸ’¡ To fix locally, run: pre-commit run --all-files"
