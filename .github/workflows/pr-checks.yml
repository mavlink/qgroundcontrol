name: PR Checks

on:
  pull_request_target:
    types: [opened, edited, synchronize, reopened, closed]

permissions:
  contents: read
  pull-requests: write
  models: read

jobs:
  title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    timeout-minutes: 5

    steps:
      - name: Check PR title format
        id: title_check
        continue-on-error: true
        uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^.{1,80}$
          subjectPatternError: PR title must be 80 characters or less.
          wip: true
          validateSingleCommit: false

      - name: Checkout prompt file
        if: steps.title_check.outcome == 'failure'
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/prompts
          sparse-checkout-cone-mode: false

      - name: Get changed files
        id: files
        if: steps.title_check.outcome == 'failure'
        uses: actions/github-script@v8
        with:
          result-encoding: string
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 50
            });
            return files.map(f => `${f.filename} (+${f.additions}/-${f.deletions})`).join('\n');

      - name: Suggest title with GitHub Models
        id: suggest
        if: steps.title_check.outcome == 'failure'
        continue-on-error: true
        uses: actions/ai-inference@v1
        with:
          prompt-file: .github/prompts/pr-title-suggestion.prompt.yml
          max-tokens: 100
          input: |
            current_title: ${{ github.event.pull_request.title }}
            pr_body: ${{ github.event.pull_request.body }}
            changed_files: ${{ steps.files.outputs.result }}

      - name: Comment title suggestion
        if: steps.title_check.outcome == 'failure' && steps.suggest.outputs.response
        uses: actions/github-script@v8
        env:
          SUGGESTED_TITLE: ${{ steps.suggest.outputs.response }}
        with:
          script: |
            const pr = context.payload.pull_request;
            const suggestedTitle = process.env.SUGGESTED_TITLE.trim();

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('<!-- pr-title-suggestion -->')
            );

            const commentBody = `<!-- pr-title-suggestion -->
            ## üìù PR Title Suggestion

            Your PR title doesn't follow the [conventional commit](https://www.conventionalcommits.org/) format.

            | Current | Suggested |
            |---------|-----------|
            | \`${pr.title}\` | \`${suggestedTitle}\` |

            ### Format
            \`<type>(<scope>): <description>\`

            **Types:** \`feat\` \`fix\` \`docs\` \`refactor\` \`perf\` \`test\` \`ci\` \`chore\` \`build\` \`style\` \`revert\`

            <sub>ü§ñ Suggested by GitHub Models ‚Ä¢ Update your title to dismiss</sub>`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: commentBody
              });
            }

      - name: Minimize suggestion if title valid
        if: steps.title_check.outcome == 'success'
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('<!-- pr-title-suggestion -->')
            );

            if (botComment && !botComment.body.includes('(resolved)')) {
              const minimizedBody = `<!-- pr-title-suggestion -->
            <details>
            <summary>üìù PR Title Suggestion (resolved ‚úì)</summary>

            ${botComment.body.replace('<!-- pr-title-suggestion -->', '')}
            </details>`;

              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: minimizedBody
              });
            }

  size:
    name: Label PR Size
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    timeout-minutes: 5

    steps:
      - name: Get current size label
        id: current
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          CURRENT_LABEL=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/labels" \
            --jq '.[] | select(.name | startswith("size/")) | .name' | head -1)
          echo "label=${CURRENT_LABEL}" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Label PR by size
        continue-on-error: true
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/XS'
          xs_max_size: 150
          s_label: 'size/S'
          s_max_size: 500
          m_label: 'size/M'
          m_max_size: 1000
          l_label: 'size/L'
          l_max_size: 1500
          xl_label: 'size/XL'
          fail_if_xl: false
          message_if_xl: |
            ## ‚ö†Ô∏è Large PR Warning

            This PR has **more than 1500 lines** changed, which can be difficult to review thoroughly.

            Consider:
            - Splitting into smaller, focused PRs
            - Separating refactoring from feature changes
            - Breaking out unrelated changes into separate PRs

            Smaller PRs get reviewed faster and reduce the risk of bugs slipping through.
          files_to_ignore: |
            package-lock.json
            *.lock
            translations/*

      - name: Remove outdated size labels
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          OLD_LABEL="${{ steps.current.outputs.label }}"

          # Get all current size labels
          CURRENT_LABELS=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/labels" \
            --jq '.[] | select(.name | startswith("size/")) | .name')

          # Count size labels - if more than one, remove the old one
          LABEL_COUNT=$(echo "$CURRENT_LABELS" | grep -c . || echo 0)

          if [[ "$LABEL_COUNT" -gt 1 && -n "$OLD_LABEL" ]]; then
            # Multiple size labels exist - remove the old one
            ENCODED_LABEL=$(echo "$OLD_LABEL" | sed 's|/|%2F|g')
            gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/labels/${ENCODED_LABEL}" \
              -X DELETE 2>/dev/null || true
          fi
          # If only one label exists, size didn't change - nothing to remove
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  label:
    name: Label PR by Files
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    timeout-minutes: 5

    steps:
      - name: Label PR by changed files
        uses: actions/labeler@v6
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          sync-labels: true

  cache-cleanup:
    name: Cleanup PR Caches
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    timeout-minutes: 15
    permissions:
      actions: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Delete PR caches
        run: |
          gh extension install actions/gh-actions-cache

          REPO="${{ github.repository }}"
          BRANCH="refs/pull/${{ github.event.pull_request.number }}/merge"

          echo "Fetching list of cache keys"
          cacheKeysForPR=$(gh actions-cache list -R "$REPO" -B "$BRANCH" | cut -f 1 )

          set +e
          echo "Deleting caches..."
          for cacheKey in $cacheKeysForPR
          do
            gh actions-cache delete "$cacheKey" -R "$REPO" -B "$BRANCH" --confirm
          done
          echo "Done"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
