name: PR Checks

on:
  pull_request_target:
    types: [opened, edited, synchronize, reopened, closed]

permissions:
  contents: write
  pull-requests: write
  actions: write
  models: read

jobs:
  title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    timeout-minutes: 5

    steps:
      - name: Check PR title format
        id: title_check
        continue-on-error: true
        uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^.{1,80}$
          subjectPatternError: PR title must be 80 characters or less.
          wip: true
          validateSingleCommit: false

      - name: Suggest title with GitHub Models
        if: steps.title_check.outcome == 'failure'
        uses: actions/github-script@v8
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const pr = context.payload.pull_request;
            const currentTitle = pr.title;

            // Get changed files for context
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 50
            });

            const fileList = files.map(f => `${f.filename} (+${f.additions}/-${f.deletions})`).join('\n');
            const prBody = (pr.body || '').slice(0, 2000);

            // Call GitHub Models API
            const response = await fetch('https://models.github.ai/inference/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.GITHUB_TOKEN}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'openai/gpt-5-mini',
                messages: [{
                  role: 'user',
                  content: `Generate a conventional commit PR title for these changes.

            Current title: ${currentTitle}

            PR Description:
            ${prBody}

            Changed files:
            ${fileList}

            Rules:
            - Format: <type>(<scope>): <description>
            - Types: feat, fix, docs, refactor, perf, test, ci, chore, build, style, revert
            - Scope should reflect main area: Vehicle, Gimbal, Camera, FlyView, PlanView, MAVLink, Comms, UI, Settings, Mission, Firmware, etc.
            - Description: imperative mood, max 60 chars, no period
            - Scope is optional if changes span multiple areas

            Reply with ONLY the suggested title, nothing else.`
                }],
                max_tokens: 100
              })
            });

            let suggestedTitle = '';
            if (response.ok) {
              const data = await response.json();
              suggestedTitle = data.choices?.[0]?.message?.content?.trim() || '';
            }

            // Fallback if API fails
            if (!suggestedTitle) {
              const scopeMap = {
                'src/Vehicle/': 'Vehicle', 'src/FlyView/': 'FlyView', 'src/PlanView/': 'PlanView',
                'src/Camera/': 'Camera', 'src/Gimbal/': 'Gimbal', 'src/MAVLink/': 'MAVLink',
                'src/Comms/': 'Comms', 'src/QmlControls/': 'UI', 'src/Settings/': 'Settings',
                'src/MissionManager/': 'Mission', 'src/FirmwarePlugin/': 'Firmware',
                '.github/': 'ci', 'docs/': 'docs'
              };
              let scope = '';
              for (const file of files) {
                for (const [path, s] of Object.entries(scopeMap)) {
                  if (file.filename.startsWith(path)) { scope = s; break; }
                }
                if (scope) break;
              }
              const scopePart = scope ? `(${scope})` : '';
              const cleanTitle = currentTitle.replace(/^\[.*?\]\s*/, '').trim();
              suggestedTitle = `feat${scopePart}: ${cleanTitle}`;
            }

            // Check for existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('<!-- pr-title-suggestion -->')
            );

            const commentBody = `<!-- pr-title-suggestion -->
            ## üìù PR Title Suggestion

            Your PR title doesn't follow the [conventional commit](https://www.conventionalcommits.org/) format.

            | Current | Suggested |
            |---------|-----------|
            | \`${currentTitle}\` | \`${suggestedTitle}\` |

            ### Format
            \`<type>(<scope>): <description>\`

            **Types:** \`feat\` \`fix\` \`docs\` \`refactor\` \`perf\` \`test\` \`ci\` \`chore\` \`build\` \`style\` \`revert\`

            <sub>ü§ñ Suggested by GitHub Models ‚Ä¢ Update your title to dismiss</sub>`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: commentBody
              });
            }

      - name: Minimize suggestion if title valid
        if: steps.title_check.outcome == 'success'
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('<!-- pr-title-suggestion -->')
            );

            if (botComment && !botComment.body.includes('(resolved)')) {
              const minimizedBody = `<!-- pr-title-suggestion -->
            <details>
            <summary>üìù PR Title Suggestion (resolved ‚úì)</summary>

            ${botComment.body.replace('<!-- pr-title-suggestion -->', '')}
            </details>`;

              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: minimizedBody
              });
            }

  size:
    name: Label PR Size
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    timeout-minutes: 5

    steps:
      - name: Get current size label
        id: current
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          CURRENT_LABEL=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/labels" \
            --jq '.[] | select(.name | startswith("size/")) | .name' | head -1)
          echo "label=${CURRENT_LABEL}" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Label PR by size
        continue-on-error: true
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/XS'
          xs_max_size: 150
          s_label: 'size/S'
          s_max_size: 500
          m_label: 'size/M'
          m_max_size: 1000
          l_label: 'size/L'
          l_max_size: 1500
          xl_label: 'size/XL'
          fail_if_xl: false
          message_if_xl: |
            ## ‚ö†Ô∏è Large PR Warning

            This PR has **more than 1500 lines** changed, which can be difficult to review thoroughly.

            Consider:
            - Splitting into smaller, focused PRs
            - Separating refactoring from feature changes
            - Breaking out unrelated changes into separate PRs

            Smaller PRs get reviewed faster and reduce the risk of bugs slipping through.
          files_to_ignore: |
            package-lock.json
            *.lock
            translations/*

      - name: Remove outdated size labels
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          OLD_LABEL="${{ steps.current.outputs.label }}"

          # Get all current size labels
          CURRENT_LABELS=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/labels" \
            --jq '.[] | select(.name | startswith("size/")) | .name')

          # Count size labels - if more than one, remove the old one
          LABEL_COUNT=$(echo "$CURRENT_LABELS" | grep -c . || echo 0)

          if [[ "$LABEL_COUNT" -gt 1 && -n "$OLD_LABEL" ]]; then
            # Multiple size labels exist - remove the old one
            ENCODED_LABEL=$(echo "$OLD_LABEL" | sed 's|/|%2F|g')
            gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/labels/${ENCODED_LABEL}" \
              -X DELETE 2>/dev/null || true
          fi
          # If only one label exists, size didn't change - nothing to remove
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  label:
    name: Label PR by Files
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    timeout-minutes: 5

    steps:
      - name: Label PR by changed files
        uses: actions/labeler@v6
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          sync-labels: true

  cache-cleanup:
    name: Cleanup PR Caches
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Delete PR caches
        run: |
          gh extension install actions/gh-actions-cache

          REPO="${{ github.repository }}"
          BRANCH="refs/pull/${{ github.event.pull_request.number }}/merge"

          echo "Fetching list of cache keys"
          cacheKeysForPR=$(gh actions-cache list -R "$REPO" -B "$BRANCH" | cut -f 1 )

          set +e
          echo "Deleting caches..."
          for cacheKey in $cacheKeysForPR
          do
            gh actions-cache delete "$cacheKey" -R "$REPO" -B "$BRANCH" --confirm
          done
          echo "Done"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
