name: PR Checks

on:
  pull_request_target:
    types: [opened, edited, synchronize, reopened, closed]

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    timeout-minutes: 5

    steps:
      - name: Check PR title format
        continue-on-error: true
        uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^.{1,80}$
          subjectPatternError: PR title must be 80 characters or less.
          wip: true
          validateSingleCommit: false

  size:
    name: Label PR Size
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    timeout-minutes: 5

    steps:
      - name: Remove old size labels
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          for label in size%2FXS size%2FS size%2FM size%2FL size%2FXL; do
            gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/labels/${label}" \
              -X DELETE 2>/dev/null || true
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Label PR by size
        continue-on-error: true
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/XS'
          xs_max_size: 150
          s_label: 'size/S'
          s_max_size: 500
          m_label: 'size/M'
          m_max_size: 1000
          l_label: 'size/L'
          l_max_size: 1500
          xl_label: 'size/XL'
          fail_if_xl: false
          message_if_xl: |
            ## ⚠️ Large PR Warning

            This PR has **more than 1500 lines** changed, which can be difficult to review thoroughly.

            Consider:
            - Splitting into smaller, focused PRs
            - Separating refactoring from feature changes
            - Breaking out unrelated changes into separate PRs

            Smaller PRs get reviewed faster and reduce the risk of bugs slipping through.
          files_to_ignore: |
            package-lock.json
            *.lock
            translations/*

  label:
    name: Label PR by Files
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    timeout-minutes: 5

    steps:
      - name: Label PR by changed files
        uses: actions/labeler@v6
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          sync-labels: true

  cache-cleanup:
    name: Cleanup PR Caches
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Delete PR caches
        run: |
          gh extension install actions/gh-actions-cache

          REPO="${{ github.repository }}"
          BRANCH="refs/pull/${{ github.event.pull_request.number }}/merge"

          echo "Fetching list of cache keys"
          cacheKeysForPR=$(gh actions-cache list -R "$REPO" -B "$BRANCH" | cut -f 1 )

          set +e
          echo "Deleting caches..."
          for cacheKey in $cacheKeysForPR
          do
            gh actions-cache delete "$cacheKey" -R "$REPO" -B "$BRANCH" --confirm
          done
          echo "Done"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
