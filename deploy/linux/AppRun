#!/bin/bash

if [ -z "$APPDIR" ]; then
    APPDIR="$(dirname "$(readlink -f "$0")")"
fi

ARCH=$(uname -m)
case "$ARCH" in
    x86_64)  MULTIARCH="x86_64-linux-gnu" ;;
    aarch64) MULTIARCH="aarch64-linux-gnu" ;;
    *)       MULTIARCH="" ;;
esac

# Check if system GLib is newer than bundled (has g_string_free_and_steal from 2.76+)
# Needed for TTS: system libspeechd.so.2 may require newer GLib symbols
SYSTEM_GLIB="/usr/lib/${MULTIARCH}/libglib-2.0.so.0"
if [ -n "$MULTIARCH" ] && [ -f "$SYSTEM_GLIB" ]; then
    if nm -D "$SYSTEM_GLIB" 2>/dev/null | grep -q g_string_free_and_steal; then
        # System GLib is 2.76+, preload it for TTS compatibility
        export LD_PRELOAD="${SYSTEM_GLIB}${LD_PRELOAD:+:$LD_PRELOAD}"
    fi
fi

if [ -n "$MULTIARCH" ]; then
    export LD_LIBRARY_PATH="${APPDIR}/usr/lib:${APPDIR}/usr/lib/gstreamer-1.0:/usr/lib/${MULTIARCH}:/lib/${MULTIARCH}:/usr/lib:${LD_LIBRARY_PATH}"
else
    echo "Warning: Unsupported architecture '${ARCH}'; using generic library paths." >&2
    export LD_LIBRARY_PATH="${APPDIR}/usr/lib:${APPDIR}/usr/lib/gstreamer-1.0:/usr/lib:${LD_LIBRARY_PATH}"
fi

unset QT_PLUGIN_PATH
unset QML2_IMPORT_PATH

export XDG_DATA_DIRS="${APPDIR}/usr/share:${XDG_DATA_DIRS:-/usr/local/share:/usr/share}"

if [ "$XDG_SESSION_TYPE" = "wayland" ]; then
    echo "QGroundControl AppImage: Forcing xcb platform (Wayland support incomplete)" >&2
    export QT_QPA_PLATFORM=xcb
fi

export GST_REGISTRY_REUSE_PLUGIN_SCANNER="no"
export GIO_EXTRA_MODULES="${APPDIR}/usr/lib/gio/modules"
export GST_PLUGIN_SCANNER_1_0="${APPDIR}/usr/lib/gstreamer1.0/gstreamer-1.0/gst-plugin-scanner"
export GST_PLUGIN_SCANNER="${APPDIR}/usr/lib/gstreamer1.0/gstreamer-1.0/gst-plugin-scanner"
export GST_PTP_HELPER_1_0="${APPDIR}/usr/lib/gstreamer1.0/gstreamer-1.0/gst-ptp-helper"
export GST_PTP_HELPER="${APPDIR}/usr/lib/gstreamer1.0/gstreamer-1.0/gst-ptp-helper"
export GST_PLUGIN_SYSTEM_PATH_1_0="${APPDIR}/usr/lib/gstreamer-1.0"
export GST_PLUGIN_SYSTEM_PATH="${APPDIR}/usr/lib/gstreamer-1.0"
export GST_PLUGIN_PATH_1_0="${APPDIR}/usr/lib/gstreamer-1.0"
export GST_PLUGIN_PATH="${APPDIR}/usr/lib/gstreamer-1.0"

exec "${APPDIR}/usr/bin/QGroundControl" "$@"
