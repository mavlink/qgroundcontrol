#!/bin/bash

if [ -z "$APPDIR" ]; then
    APPDIR="$(dirname "$(readlink -f "$0")")"
fi

ARCH=$(uname -m)
case "$ARCH" in
    x86_64)  MULTIARCH="x86_64-linux-gnu" ;;
    aarch64) MULTIARCH="aarch64-linux-gnu" ;;
    *)       MULTIARCH="" ;;
esac

SYSTEM_GLIB=""
SYSTEM_GIO=""
for LIB_PATH in \
    "/usr/lib/${MULTIARCH}" \
    "/usr/lib64" \
    "/usr/lib"; do
    if [ -f "${LIB_PATH}/libglib-2.0.so.0" ]; then
        SYSTEM_GLIB="${LIB_PATH}/libglib-2.0.so.0"
        SYSTEM_GIO="${LIB_PATH}/libgio-2.0.so.0"
        break
    fi
done

# Preload system GLib 2.76+ for TTS compatibility (libspeechd.so.2 dependency)
if [ -n "$SYSTEM_GLIB" ]; then
    if nm -D "$SYSTEM_GLIB" 2>/dev/null | grep -q g_string_free_and_steal; then
        export LD_PRELOAD="${SYSTEM_GLIB}${LD_PRELOAD:+:$LD_PRELOAD}"
    fi
fi

# Use system OpenGL libraries to avoid conflicts with bundled libGLESv2
# Bundled GLES can conflict with system desktop OpenGL causing "Unrecognized OpenGL version"
SYSTEM_LIBDIR="${LIB_PATH:-/usr/lib/${MULTIARCH}}"
if [ -f "${SYSTEM_LIBDIR}/libEGL.so.1" ]; then
    export LD_PRELOAD="${SYSTEM_LIBDIR}/libEGL.so.1:${SYSTEM_LIBDIR}/libGLESv2.so.2${LD_PRELOAD:+:$LD_PRELOAD}"
fi

if [ -n "$MULTIARCH" ]; then
    export LD_LIBRARY_PATH="${APPDIR}/usr/lib:${APPDIR}/usr/lib/gstreamer-1.0:/usr/lib/${MULTIARCH}:/lib/${MULTIARCH}:/usr/lib64:/usr/lib:${LD_LIBRARY_PATH}"
else
    echo "Warning: Unsupported architecture '${ARCH}'; using generic library paths." >&2
    export LD_LIBRARY_PATH="${APPDIR}/usr/lib:${APPDIR}/usr/lib/gstreamer-1.0:/usr/lib64:/usr/lib:${LD_LIBRARY_PATH}"
fi

unset QT_PLUGIN_PATH
unset QML2_IMPORT_PATH
# gst-plugin-scanner may use host Python; isolate it from virtualenv/conda paths
# that often omit distro gi bindings needed by gst-python.
unset PYTHONHOME
unset PYTHONPATH
unset VIRTUAL_ENV
unset CONDA_PREFIX
unset CONDA_DEFAULT_ENV
unset PYTHONUSERBASE
export PYTHONNOUSERSITE=1

export XDG_DATA_DIRS="${APPDIR}/usr/share:${XDG_DATA_DIRS:-/usr/local/share:/usr/share}"

# Find the main executable (prefer known names, fall back to first executable)
QGC_BINARY=""
# Try known binary names first for security (prevents malicious binary injection)
for expected_name in QGroundControl Custom-QGroundControl; do
    if [ -x "${APPDIR}/usr/bin/${expected_name}" ] && [ -f "${APPDIR}/usr/bin/${expected_name}" ]; then
        QGC_BINARY="${APPDIR}/usr/bin/${expected_name}"
        break
    fi
done
# Fallback to first executable (for custom builds with different names)
if [ -z "$QGC_BINARY" ]; then
    for bin in "${APPDIR}/usr/bin/"*; do
        if [ -x "$bin" ] && [ -f "$bin" ]; then
            QGC_BINARY="$bin"
            echo "Warning: Using non-standard binary: $(basename "$bin")" >&2
            break
        fi
    done
fi

if [ -z "$QGC_BINARY" ]; then
    echo "Error: No executable found in ${APPDIR}/usr/bin/" >&2
    exit 1
fi

QGC_NAME=$(basename "$QGC_BINARY")

if [ "$XDG_SESSION_TYPE" = "wayland" ]; then
    echo "${QGC_NAME} AppImage: Forcing xcb platform (Wayland support incomplete)" >&2
    export QT_QPA_PLATFORM=xcb
fi

export GST_REGISTRY_REUSE_PLUGIN_SCANNER="no"

# GIO 2.76+ system modules require symbols missing from bundled GIO - use bundled modules only
unset GIO_EXTRA_MODULES
unset GIO_MODULE_DIR
unset GIO_USE_VFS
if [ -n "$SYSTEM_GIO" ] && nm -D "$SYSTEM_GIO" 2>/dev/null | grep -q g_task_set_static_name; then
    export GIO_MODULE_DIR="${APPDIR}/usr/lib/gio/modules"
    export GIO_USE_VFS="local"
else
    export GIO_EXTRA_MODULES="${APPDIR}/usr/lib/gio/modules"
fi

GST_PLUGIN_DIR="${APPDIR}/usr/lib/gstreamer-1.0"
GST_SCANNER="${APPDIR}/usr/lib/gstreamer1.0/gstreamer-1.0/gst-plugin-scanner"
GST_PTP="${APPDIR}/usr/lib/gstreamer1.0/gstreamer-1.0/gst-ptp-helper"

if [ -d "${GST_PLUGIN_DIR}" ]; then
    export GST_PLUGIN_SYSTEM_PATH_1_0="${GST_PLUGIN_DIR}"
    export GST_PLUGIN_SYSTEM_PATH="${GST_PLUGIN_DIR}"
    export GST_PLUGIN_PATH_1_0="${GST_PLUGIN_DIR}"
    export GST_PLUGIN_PATH="${GST_PLUGIN_DIR}"
else
    echo "Warning: bundled GStreamer plugin directory missing: ${GST_PLUGIN_DIR}" >&2
    unset GST_PLUGIN_SYSTEM_PATH_1_0 GST_PLUGIN_SYSTEM_PATH GST_PLUGIN_PATH_1_0 GST_PLUGIN_PATH
fi

if [ -x "${GST_SCANNER}" ]; then
    export GST_PLUGIN_SCANNER_1_0="${GST_SCANNER}"
    export GST_PLUGIN_SCANNER="${GST_SCANNER}"
else
    echo "Warning: bundled gst-plugin-scanner missing or not executable: ${GST_SCANNER}" >&2
    unset GST_PLUGIN_SCANNER_1_0 GST_PLUGIN_SCANNER
fi

if [ -x "${GST_PTP}" ]; then
    export GST_PTP_HELPER_1_0="${GST_PTP}"
    export GST_PTP_HELPER="${GST_PTP}"
else
    echo "Warning: bundled gst-ptp-helper missing or not executable: ${GST_PTP}" >&2
    unset GST_PTP_HELPER_1_0 GST_PTP_HELPER
fi

exec "$QGC_BINARY" "$@"
