FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

# Copy build config and setup scripts
COPY .github/build-config.json /tmp/qt/
COPY tools/setup/install_dependencies.py /tmp/qt/
COPY tools/setup/read_config.py /tmp/qt/
RUN apt-get update && apt-get install -y --no-install-recommends python3 && \
    python3 /tmp/qt/install_dependencies.py --platform debian

# Read all versions from centralized config
RUN echo "export QT_VERSION=$(python3 /tmp/qt/read_config.py --get qt_version)" >> /etc/profile.d/qgc.sh && \
    echo "export QT_MODULES=\"$(python3 /tmp/qt/read_config.py --get qt_modules)\"" >> /etc/profile.d/qgc.sh && \
    echo "export JAVA_VERSION=$(python3 /tmp/qt/read_config.py --get java_version)" >> /etc/profile.d/qgc.sh && \
    echo "export NDK_FULL_VERSION=$(python3 /tmp/qt/read_config.py --get ndk_full_version)" >> /etc/profile.d/qgc.sh && \
    echo "export ANDROID_PLATFORM=$(python3 /tmp/qt/read_config.py --get android_platform)" >> /etc/profile.d/qgc.sh && \
    echo "export ANDROID_BUILD_TOOLS=$(python3 /tmp/qt/read_config.py --get android_build_tools)" >> /etc/profile.d/qgc.sh && \
    echo "export ANDROID_CMDLINE_TOOLS=$(python3 /tmp/qt/read_config.py --get android_cmdline_tools)" >> /etc/profile.d/qgc.sh && \
    chmod +x /etc/profile.d/qgc.sh

RUN . /etc/profile.d/qgc.sh && apt-get install -y openjdk-${JAVA_VERSION}-jdk

ENV ANDROID_SDK_ROOT=/opt/android-sdk
ENV ANDROID_HOME=$ANDROID_SDK_ROOT

# Install Android SDK and NDK
RUN . /etc/profile.d/qgc.sh && \
    mkdir -p $ANDROID_SDK_ROOT/cmdline-tools/latest && \
    wget "https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_CMDLINE_TOOLS}_latest.zip" -O /opt/cmdline-tools.zip && \
    unzip /opt/cmdline-tools.zip -d $ANDROID_SDK_ROOT/cmdline-tools && \
    mv $ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools/* $ANDROID_SDK_ROOT/cmdline-tools/latest/ && \
    rm -rf $ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools && \
    rm /opt/cmdline-tools.zip && \
    yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT --licenses && \
    $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT \
        "platform-tools" \
        "platforms;android-${ANDROID_PLATFORM}" \
        "build-tools;${ANDROID_BUILD_TOOLS}" \
        "ndk;${NDK_FULL_VERSION}" && \
    echo "export ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/${NDK_FULL_VERSION}" >> /etc/profile.d/qgc.sh && \
    echo "export ANDROID_BUILD_TOOLS_DIR=$ANDROID_SDK_ROOT/build-tools/${ANDROID_BUILD_TOOLS}" >> /etc/profile.d/qgc.sh

# Qt setup
ENV QT_PATH="/opt/Qt"
ENV QT_HOST="linux"
ENV QT_HOST_ARCH="linux_gcc_64"
ENV QT_HOST_DIR="gcc_64"
ENV QT_TARGET="android"
# ENV QT_TARGET_ARCH_ARMV7="android_armv7"
ENV QT_TARGET_ARCH_ARM64="android_arm64_v8a"

# Install Qt for host and target architectures using aqtinstall
# Note: aqtinstall uses linux_gcc_64 as arch param but creates gcc_64 directory
RUN . /etc/profile.d/qgc.sh && \
    apt-get update && apt-get install -y pipx && \
    mkdir -p $QT_PATH && \
    pipx run aqtinstall install-qt $QT_HOST desktop $QT_VERSION $QT_HOST_ARCH -O $QT_PATH -m $QT_MODULES && \
    pipx run aqtinstall install-qt all_os $QT_TARGET $QT_VERSION $QT_TARGET_ARCH_ARM64 -O $QT_PATH -m $QT_MODULES --autodesktop && \
    echo "export QT_ROOT_DIR_ARM64=$QT_PATH/$QT_VERSION/$QT_TARGET_ARCH_ARM64" >> /etc/profile.d/qgc.sh && \
    echo "export QT_HOST_PATH=$QT_PATH/$QT_VERSION/$QT_HOST_DIR" >> /etc/profile.d/qgc.sh

# Optional: Uncomment to enable ARMv7 builds (requires QT_TARGET_ARCH_ARMV7 env var above)
# RUN . /etc/profile.d/qgc.sh && \
#     pipx run aqtinstall install-qt all_os $QT_TARGET $QT_VERSION $QT_TARGET_ARCH_ARMV7 -O $QT_PATH -m $QT_MODULES --autodesktop && \
#     echo "export QT_ROOT_DIR_ARMV7=$QT_PATH/$QT_VERSION/$QT_TARGET_ARCH_ARMV7" >> /etc/profile.d/qgc.sh

RUN . /etc/profile.d/qgc.sh && \
    echo "export JAVA_HOME=/usr/lib/jvm/java-${JAVA_VERSION}-openjdk-amd64" >> /etc/profile.d/qgc.sh

# Consolidate PATH settings
# Note: Add $QT_ROOT_DIR_ARMV7 to enable ARMv7
RUN echo 'export PATH=$JAVA_HOME/bin:/usr/lib/ccache:$QT_HOST_PATH/bin:$QT_ROOT_DIR_ARM64/bin:$PATH:$ANDROID_SDK_ROOT/tools:$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_BUILD_TOOLS_DIR:$ANDROID_NDK_ROOT' >> /etc/profile.d/qgc.sh

RUN locale-gen en_US.UTF-8 && update-locale LANG=en_US.UTF-8

RUN git config --global --add safe.directory /project/source

# Use login shell for profile sourcing
SHELL ["/bin/bash", "-lc"]

# Set working directory
WORKDIR /project/build

# Entrypoint
COPY deploy/docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/bin/bash", "-l", "/entrypoint.sh"]
CMD ["Release"]
