# ---------- Base image ----------
FROM ubuntu:24.04

# ---------- Non-interactive APT ----------
ENV DEBIAN_FRONTEND=noninteractive

# ---------- System packages ----------
#  * locales   – lets us generate UTF-8 locales
#  * git       – you call `git config` later and most build scripts need it
#  * ninja-build & cmake – required by your CMD
#  * ca-certificates, build-essential, curl, unzip – common essentials
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        locales \
        git \
        ninja-build \
        cmake \
        ca-certificates \
        build-essential \
        curl \
        unzip && \
    rm -rf /var/lib/apt/lists/*

# ---------- UTF-8 locale ----------
RUN sed -i 's/^# *\(en_US.UTF-8 UTF-8\)/\1/' /etc/locale.gen && \
    locale-gen && \
    update-locale LANG=en_US.UTF-8
ENV LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    LC_ALL=en_US.UTF-8

# ---------- Bring in the helper scripts and config ----------
COPY .github/build-config.json /tmp/qt/
COPY tools/setup/install-dependencies-debian.sh /tmp/qt/
COPY tools/setup/install-qt-debian.sh /tmp/qt/
COPY tools/setup/read-config.sh /tmp/qt/
RUN chmod +x /tmp/qt/*.sh && \
    /tmp/qt/install-dependencies-debian.sh && \
    /tmp/qt/install-qt-debian.sh

# Extract Qt version and set environment (scripts install to /opt/Qt/<version>/gcc_64)
RUN QT_VERSION=$(/tmp/qt/read-config.sh --get qt_version) && \
    echo "export QT_ROOT_DIR=/opt/Qt/${QT_VERSION}/gcc_64" >> /etc/profile.d/qt.sh && \
    echo 'export PATH=$QT_ROOT_DIR/bin:$PATH' >> /etc/profile.d/qt.sh && \
    chmod +x /etc/profile.d/qt.sh && \
    rm -rf /tmp/qt

# Source qt.sh in bash login shells; for non-login, find Qt dynamically
SHELL ["/bin/bash", "-lc"]

# ---------- Git safe directory (avoids “detected dubious ownership”) ----------
RUN git config --global --add safe.directory /project/source

# ---------- Work directories ----------
# They will be mounted as volumes when you run the container
RUN mkdir -p /project/source /project/build
WORKDIR /project/build

# ---------- Build + install when the container starts ----------
ENV BUILD_TYPE=Release

CMD ["bash", "-lc", "\
  case \"${BUILD_TYPE}\" in Release|Debug|RelWithDebInfo|MinSizeRel) ;; \n\
    *) echo \"Invalid BUILD_TYPE: ${BUILD_TYPE}\"; exit 1 ;; esac && \n\
  qt-cmake -S /project/source -B /project/build -G Ninja -DCMAKE_BUILD_TYPE=${BUILD_TYPE} && \
  cmake --build /project/build --target all --parallel && \
  cmake --install /project/build --config ${BUILD_TYPE} \
"]
