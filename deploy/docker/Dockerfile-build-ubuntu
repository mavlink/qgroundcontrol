# ---------- Base image ----------
FROM ubuntu:24.04

# ---------- Non-interactive APT ----------
ENV DEBIAN_FRONTEND=noninteractive

# ---------- System packages ----------
#  * locales   – lets us generate UTF-8 locales
#  * git       – you call `git config` later and most build scripts need it
#  * ninja-build & cmake – required by your CMD
#  * ca-certificates, build-essential, curl, unzip – common essentials
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        locales \
        git \
        ninja-build \
        cmake \
        ca-certificates \
        build-essential \
        curl \
        unzip && \
    rm -rf /var/lib/apt/lists/*

# ---------- UTF-8 locale ----------
RUN sed -i 's/^# *\(en_US.UTF-8 UTF-8\)/\1/' /etc/locale.gen && \
    locale-gen && \
    update-locale LANG=en_US.UTF-8
ENV LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    LC_ALL=en_US.UTF-8

# ---------- Bring in the helper scripts and config ----------
COPY .github/build-config.json /tmp/qt/
COPY tools/setup/install_dependencies.py /tmp/qt/
COPY tools/setup/read_config.py /tmp/qt/
RUN apt-get update && apt-get install -y --no-install-recommends python3 pipx && \
    python3 /tmp/qt/install_dependencies.py --platform debian && \
    QT_VERSION=$(python3 /tmp/qt/read_config.py --get qt_version) && \
    QT_MODULES=$(python3 /tmp/qt/read_config.py --get qt_modules) && \
    mkdir -p /opt/Qt && \
    pipx run aqtinstall install-qt linux desktop "${QT_VERSION}" linux_gcc_64 -O /opt/Qt -m ${QT_MODULES} && \
    echo "export QT_ROOT_DIR=/opt/Qt/${QT_VERSION}/gcc_64" >> /etc/profile.d/qt.sh && \
    echo 'export PATH=$QT_ROOT_DIR/bin:$PATH' >> /etc/profile.d/qt.sh && \
    chmod +x /etc/profile.d/qt.sh && \
    rm -rf /var/lib/apt/lists/* && \
    rm -rf /tmp/qt

# Source qt.sh in bash login shells; for non-login, find Qt dynamically
SHELL ["/bin/bash", "-lc"]

# ---------- Git safe directory (avoids “detected dubious ownership”) ----------
RUN git config --global --add safe.directory /project/source

# ---------- Work directories ----------
# They will be mounted as volumes when you run the container
RUN mkdir -p /project/source /project/build
WORKDIR /project/build

# ---------- Entrypoint ----------
COPY deploy/docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/bin/bash", "-l", "/entrypoint.sh"]
CMD ["Release"]
