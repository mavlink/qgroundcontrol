/****************************************************************************
 *
 * (c) 2009-2024 QGROUNDCONTROL PROJECT <http://www.qgroundcontrol.org>
 *
 * QGroundControl is licensed according to the terms in the file
 * COPYING.md in the root of the source code directory.
 *
 ****************************************************************************/

#include "{{ spec.class_name }}.h"
#include "Vehicle.h"

#include <cmath>

{{ spec.class_name }}::{{ spec.class_name }}(QObject *parent)
    : FactGroup({{ spec.update_rate_ms }}, QStringLiteral("{{ spec.json_resource_path }}"), parent)
{
{% for fact in spec.facts %}
    _addFact(&_{{ fact.name }}Fact);
{% endfor %}

    // Initialize with NaN to indicate no data
{% for fact in spec.facts %}
{% if fact.value_type in ('double', 'float') %}
    _{{ fact.name }}Fact.setRawValue(std::numeric_limits<double>::quiet_NaN());
{% else %}
    _{{ fact.name }}Fact.setRawValue(0);
{% endif %}
{% endfor %}
}

void {{ spec.class_name }}::handleMessage(Vehicle *vehicle, const mavlink_message_t &message)
{
    Q_UNUSED(vehicle);

{% if spec.mavlink_messages %}
    switch (message.msgid) {
{% for msg in spec.mavlink_messages %}
    case {{ msg.msg_id_constant }}:
        {{ msg.handler_name }}(message);
        break;
{% endfor %}
    default:
        break;
    }
{% else %}
    Q_UNUSED(message);
    // TODO: Add MAVLink message handlers
{% endif %}
}

{% for msg in spec.mavlink_messages %}
void {{ spec.class_name }}::{{ msg.handler_name }}(const mavlink_message_t &message)
{
    {{ msg.struct_name }} decoded{};
    {{ msg.decode_func }}(&message, &decoded);

    // TODO: Update facts from decoded message
    // Example:
    // _speedFact.setRawValue(decoded.speed);

    _setTelemetryAvailable(true);
}

{% endfor %}
