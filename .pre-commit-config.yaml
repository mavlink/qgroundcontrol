# QGroundControl Pre-Commit Configuration
# Install: pre-commit install
# Run: pre-commit run --all-files
# Update: pre-commit autoupdate

repos:
  # Basic file checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: check-yaml
        args: [--allow-multiple-documents, --unsafe]
      - id: check-json
        exclude: ^\.vscode/  # VSCode uses JSONC (JSON with comments)
      - id: check-xml
        exclude: ^test/
      - id: check-merge-conflict
      - id: check-added-large-files
        args: ['--maxkb=1000']
      - id: trailing-whitespace
        args: ['--markdown-linebreak-ext=md']
        exclude: ^translations/
      - id: end-of-file-fixer
        exclude: ^(translations/.*\.ts|.*\.(png|jpg|jpeg|gif|svg|ico|bin|dat))$
      - id: mixed-line-ending
        args: ['--fix=lf']
        exclude: \.(bat|ps1)$

  # C++ formatting (commented out - uncomment to enable)
  # - repo: https://github.com/pre-commit/mirrors-clang-format
  #   rev: v19.1.7
  #   hooks:
  #     - id: clang-format
  #       types_or: [c++, c]
  #       args: ['-i']
  #       exclude: ^build/

  # Python formatting
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.9.1
    hooks:
      - id: ruff
        args: [--fix]
      - id: ruff-format

  # Shell scripts
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.11.0.1
    hooks:
      - id: shellcheck
        args: ['-x', '-e', 'SC1091']  # -x follows sources, -e excludes SC1091 (not following)

  # YAML validation
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.37.1
    hooks:
      - id: yamllint
        args: ['-d', '{extends: default, rules: {line-length: {max: 200}, document-start: disable, truthy: {check-keys: false}, comments: {min-spaces-from-content: 1}}}']

  # QGC-specific checks
  - repo: local
    hooks:
      - id: qmllint
        name: Lint QML files
        entry: bash -c 'if command -v qmllint &>/dev/null; then qmllint "$@" || true; else echo "qmllint not found - skipping QML linting (install qt6-declarative-dev-tools or Qt SDK)"; fi' --
        language: system
        files: \.qml$
        exclude: ^build/
        pass_filenames: true

      - id: check-fact-metadata
        name: Validate Fact metadata JSON
        entry: python3
        language: system
        files: '\.FactMetaData\.json$|\.SettingsGroup\.json$'
        pass_filenames: true
        args:
          - -c
          - |
            import sys, json
            for f in sys.argv[1:]:
                try:
                    with open(f) as fp:
                        json.load(fp)
                except Exception as e:
                    print(f"Invalid JSON in {f}: {e}")
                    sys.exit(1)

      - id: check-no-qassert
        name: Check for Q_ASSERT in production code
        entry: python3
        language: system
        files: \.(h|cc|cpp)$
        exclude: ^test/
        pass_filenames: true
        verbose: true
        args:
          - -c
          - |
            import sys, re
            found = []
            for filepath in sys.argv[1:]:
                try:
                    with open(filepath) as f:
                        for i, line in enumerate(f, 1):
                            if 'Q_ASSERT' in line and not line.strip().startswith('//'):
                                found.append(f"{filepath}:{i}: {line.rstrip()}")
                except Exception:
                    pass
            if found:
                print("Warning: Q_ASSERT found. Consider defensive checks with early returns instead.")
                print("Q_ASSERT is removed in release builds and can hide bugs.\n")
                for f in found:
                    print(f"  {f}")
                # Exit 0 to warn but not block (change to sys.exit(1) to enforce)
            sys.exit(0)

      - id: check-old-qml-connections
        name: Check for deprecated QML Connections syntax
        entry: python3
        language: system
        files: \.qml$
        exclude: ^build/
        pass_filenames: true
        args:
          - -c
          - |
            import sys, re

            # Pattern for old-style signal handlers: onSignalName: (not function onSignalName)
            OLD_HANDLER = re.compile(r'^\s+on[A-Z][a-zA-Z0-9]*\s*:\s*[^/]')
            CONNECTIONS_START = re.compile(r'Connections\s*\{')
            FUNCTION_HANDLER = re.compile(r'^\s+function\s+on[A-Z]')

            errors = []
            for filepath in sys.argv[1:]:
                try:
                    with open(filepath) as f:
                        content = f.read()
                        lines = content.split('\n')

                    # Only check files that have Connections blocks
                    if 'Connections' not in content:
                        continue

                    in_connections = 0
                    for i, line in enumerate(lines, 1):
                        if CONNECTIONS_START.search(line):
                            in_connections += 1
                        elif in_connections > 0:
                            if '{' in line:
                                in_connections += line.count('{')
                            if '}' in line:
                                in_connections -= line.count('}')
                            # Check for old-style handler inside Connections
                            if OLD_HANDLER.match(line) and not FUNCTION_HANDLER.match(line):
                                errors.append(f"{filepath}:{i}: {line.strip()}")
                except Exception as e:
                    print(f"Error reading {filepath}: {e}", file=sys.stderr)

            if errors:
                print("Deprecated QML Connections syntax found. Use 'function onSignal()' instead of 'onSignal:'")
                print("See: https://doc.qt.io/qt-6/qml-qtqml-connections.html")
                print()
                for err in errors:
                    print(f"  {err}")
                # Exit 0 to warn but not block (change to sys.exit(1) to enforce)
            sys.exit(0)

exclude: ^build/
