# QGroundControl Pre-Commit Configuration
# Install: pre-commit install
# Run: pre-commit run --all-files
# Update: pre-commit autoupdate

repos:
  # Basic file checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: check-yaml
        args: [--allow-multiple-documents, --unsafe]
      - id: check-json
      - id: check-xml
        exclude: ^test/
      - id: check-merge-conflict
      - id: check-added-large-files
        args: ['--maxkb=1000']
      - id: trailing-whitespace
        args: ['--markdown-linebreak-ext=md']
        exclude: ^translations/
      - id: end-of-file-fixer
        exclude: ^(translations/.*\.ts|.*\.(png|jpg|jpeg|gif|svg|ico|bin|dat))$
      - id: mixed-line-ending
        args: ['--fix=lf']
        exclude: \.(bat|ps1)$

  # C++ formatting (commented out - uncomment to enable)
  # - repo: https://github.com/pre-commit/mirrors-clang-format
  #   rev: v19.1.7
  #   hooks:
  #     - id: clang-format
  #       types_or: [c++, c]
  #       args: ['-i']
  #       exclude: ^build/

  # Python formatting
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.9.1
    hooks:
      - id: ruff
        args: [--fix]
      - id: ruff-format

  # Shell scripts
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.11.0.1
    hooks:
      - id: shellcheck
        args: ['-e', 'SC1091']  # Don't warn about not following sourced files

  # YAML validation
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.37.1
    hooks:
      - id: yamllint
        args: ['-d', '{extends: default, rules: {line-length: {max: 200}, document-start: disable, truthy: {check-keys: false}, comments: {min-spaces-from-content: 1}}}']

  # QGC-specific checks
  - repo: local
    hooks:
      - id: qmllint
        name: Lint QML files
        entry: bash -c 'if command -v qmllint &>/dev/null; then qmllint "$@" || true; else echo "qmllint not found - skipping QML linting (install qt6-declarative-dev-tools or Qt SDK)"; fi' --
        language: system
        files: \.qml$
        exclude: ^build/
        pass_filenames: true

      - id: check-fact-metadata
        name: Validate Fact metadata JSON
        entry: python3
        language: system
        files: '\.FactMetaData\.json$|\.SettingsGroup\.json$'
        pass_filenames: true
        args:
          - -c
          - |
            import sys, json
            for f in sys.argv[1:]:
                try:
                    with open(f) as fp:
                        json.load(fp)
                except Exception as e:
                    print(f"Invalid JSON in {f}: {e}")
                    sys.exit(1)

      - id: check-no-qassert
        name: Check for Q_ASSERT in production code
        entry: bash
        language: system
        files: \.(h|cc|cpp)$
        exclude: ^(test/|UnitTest\.h|UnitTest\.cc)
        pass_filenames: false
        args:
          - -c
          - |
            FILES=$(git diff --cached --name-only --diff-filter=d | grep -E '\.(h|cc|cpp)$' | grep -v '^test/' || true)
            if [ -n "$FILES" ]; then
              if echo "$FILES" | xargs grep -n 'Q_ASSERT' 2>/dev/null; then
                echo "Warning: Q_ASSERT found in production code. Consider using defensive checks with early returns."
              fi
            fi

exclude: ^build/
